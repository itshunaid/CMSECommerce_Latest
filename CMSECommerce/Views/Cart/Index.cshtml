@model CartViewModel

@{
    ViewData["Title"] = "Shopping Cart";
    var hasOutOfStockItems = Model.CartItems.Any(x => x.IsOutOfStock);
}

<div class="container my-4 amazon-cart">

    @if (Model.CartItems.Any())
    {
        <!-- PAGE TITLE -->
        <h2 class="fw-bold mb-4">Shopping Cart</h2>

        <div class="row">

            <!-- LEFT COLUMN : CART ITEMS -->
            <div class="col-lg-8">

                @if (hasOutOfStockItems)
                {
                    <div class="alert alert-danger d-flex align-items-center mb-4 rounded-3">
                        <i class="bi bi-exclamation-octagon-fill fs-4 me-3"></i>
                        <span><b>Stock Alert:</b> Some items exceed available stock. Please adjust quantity.</span>
                    </div>
                }

                @foreach (var item in Model.CartItems)
                {
                    var dangerClass = item.IsOutOfStock ? "border-danger bg-danger-subtle" : "border-light";

                    <div class="card border rounded-3 mb-3 shadow-sm @dangerClass">

                        <div class="card-body p-3">

                            <div class="row g-3 align-items-center">

                                <!-- IMAGE -->
                                <div class="col-3 col-sm-2">
                                    <img src="/media/products/@item.Image"
                                         class="img-fluid rounded"
                                         alt="@item.ProductName">
                                </div>

                                <!-- DETAILS -->
                                <div class="col-9 col-sm-6">

                                    <h6 class="fw-bold mb-1">@item.ProductName</h6>

                                    <p class="text-muted small mb-2">
                                        Price: <span class="fw-bold text-dark">@item.Price.ToString("C2")</span>
                                    </p>

                                    @if (item.IsOutOfStock)
                                    {
                                        <p class="text-danger small fw-bold">⚠ Quantity exceeds stock limit</p>
                                    }

                                    <!-- QUANTITY DROPDOWN LIKE AMAZON -->
                                    <form method="post" asp-action="UpdateQuantity" class="d-inline">
                                        <select name="quantity"
                                                class="form-select form-select-sm d-inline-block w-auto"
                                                onchange="this.form.submit()">
                                            @for (int q = 1; q <= 10; q++)
                                            {
                                                if (q == item.Quantity)
                                                {
                                                    <option value="@q" selected>@q</option>
                                                }
                                                else
                                                {
                                                    <option value="@q">@q</option>
                                                }
                                            }
                                        </select>
                                        <input type="hidden" name="id" value="@item.ProductId" />
                                    </form>

                                    <a asp-action="Remove" asp-route-id="@item.ProductId"
                                       class="text-danger small ms-3 text-decoration-none">
                                        Delete
                                    </a>

                                </div>

                                <!-- PRICE (RIGHT ALIGNED LIKE AMAZON) -->
                                <div class="col-12 col-sm-4 text-end">
                                    @{
                                        var total = item.Price * item.Quantity;
                                    }
                                    <h5 class="fw-bold text-success">@total.ToString("C2")</h5>
                                </div>

                            </div>

                        </div>

                    </div>
                }

                <a asp-controller="Home" asp-action="Index"
                   class="btn btn-outline-primary rounded-pill px-4 mt-3">
                    Continue Shopping
                </a>

            </div>

            <!-- RIGHT SIDE SUMMARY -->
            <div class="col-lg-4">

                <div class="card shadow-sm border-0 rounded-3 sticky-top" style="top: 20px;">

                    <div class="card-body p-4">

                        <h5 class="fw-bold mb-3">Order Summary</h5>

                        <div class="d-flex justify-content-between mb-3">
                            <span class="fw-semibold">Items:</span>
                            <span class="fw-bold">@Model.CartItems.Count</span>
                        </div>

                        <div class="d-flex justify-content-between border-top pt-3">
                            <span class="fw-bold fs-5">Total:</span>
                            <span class="fw-bold fs-4 text-success">@Model.GrandTotal.ToString("C2")</span>
                        </div>

                        <hr />

                        <!-- LOGIN STATUS -->
                        @if (!User.Identity.IsAuthenticated)
                        {
                            <p class="text-center small text-muted mb-2">Log in to continue</p>

                            <a asp-area="Identity" asp-controller="Account" asp-action="Login"
                               asp-route-ReturnUrl="@Url.Action("Index", "Cart")"
                               class="btn btn-warning btn-lg w-100 rounded-pill fw-bold text-dark">
                                Login to Checkout
                            </a>
                        }
                        else
                        {
                            <p class="text-success text-center small fw-bold">
                                Logged in as @User.Identity.Name
                            </p>

                            <form asp-controller="Orders" asp-action="Create" method="post">
                                <button type="submit"
                                        class="btn btn-warning btn-lg w-100 rounded-pill fw-bold text-dark"
                                        @(hasOutOfStockItems ? "disabled" : "")>
                                    Proceed to Buy
                                </button>
                            </form>

                            @if (hasOutOfStockItems)
                            {
                                <div class="alert alert-danger small mt-2 text-center py-2">
                                    Fix stock issues to continue.
                                </div>
                            }
                        }

                        <a asp-action="Clear"
                           class="btn btn-outline-danger mt-3 w-100 rounded-pill">
                            Clear Cart
                        </a>

                    </div>

                </div>

            </div>

        </div>
    }
    else
    {
        <!-- EMPTY CART AMAZON STYLE -->
        <div class="text-center py-5 bg-light rounded border shadow-sm">

            <i class="bi bi-cart-x display-1 text-warning"></i>

            <h3 class="fw-bold mt-3">Your Amazon-style Cart is Empty</h3>

            <p class="text-muted">Browse products and add them to your cart.</p>

            <a asp-controller="Products" asp-action="Index"
               class="btn btn-warning btn-lg rounded-pill fw-bold text-dark px-4">
                Shop Now
            </a>

        </div>
    }

</div>

<style>
    /* Amazon Theme Enhancements */
    .amazon-cart .card {
        border-radius: 12px !important;
    }
    .amazon-cart select {
        min-width: 60px;
    }
    .amazon-cart .btn-warning {
        background-color: #FFD814;
        border-color: #FCD200;
    }
    .amazon-cart .btn-warning:hover {
        background-color: #F7CA00;
    }
</style>
