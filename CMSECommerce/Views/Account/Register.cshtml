@model User

@{
    ViewData["Title"] = "Create Account";
}

<div class="amazon-login-page py-4">
    <div class="container d-flex justify-content-center">
        <div class="col-lg-5 col-md-7 col-sm-10">

            <div class="amazon-form-box p-4 border rounded shadow-sm bg-white">
                <h1 class="h3 fw-bold mb-4 text-amazon-dark">Create account</h1>

                <form asp-action="Register" method="post" id="registrationForm">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger small p-2" role="alert"></div>

                    <div class="form-group mb-3">
                        <label asp-for="UserName" class="form-label fw-bold small text-amazon-dark mb-1">User name</label>
                        <input asp-for="UserName" id="UserNameInput" class="form-control amazon-input-field" placeholder="Username" />
                        <span asp-validation-for="UserName" id="UserNameError" class="text-danger small mt-1 d-block"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="Email" class="form-label fw-bold small text-amazon-dark mb-1">Email</label>
                        <input type="email" asp-for="Email" id="EmailInput" class="form-control amazon-input-field" placeholder="example@@domain.com" />
                        <span asp-validation-for="Email" id="EmailError" class="text-danger small mt-1 d-block"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="PhoneNumber" class="form-label fw-bold small text-amazon-dark mb-1">Mobile Number</label>
                        <input asp-for="PhoneNumber" id="PhoneInput" class="form-control amazon-input-field" placeholder="10-digit mobile number" maxlength="10" />
                        <span asp-validation-for="PhoneNumber" id="PhoneError" class="text-danger small mt-1 d-block"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="Password" class="form-label fw-bold small text-amazon-dark mb-1">Password</label>
                        <input asp-for="Password" type="password" class="form-control amazon-input-field" placeholder="At least 6 characters" />
                        <span asp-validation-for="Password" class="text-danger small mt-1 d-block"></span>
                        <div class="small text-muted mt-1">
                            <i class="fas fa-info-circle me-1"></i> Passwords must be at least 6 characters.
                        </div>
                    </div>

                    <div class="form-group mb-4">
                        <label asp-for="ConfirmPassword" class="form-label fw-bold small text-amazon-dark mb-1">Re-enter password</label>
                        <input asp-for="ConfirmPassword" type="password" class="form-control amazon-input-field" />
                        <span asp-validation-for="ConfirmPassword" class="text-danger small mt-1 d-block"></span>
                    </div>

                    <hr class="mb-4" />
                    <h4 class="h5 fw-bold mb-3 text-amazon-dark">Shipping Address</h4>

                    <div class="form-group mb-3">
                        <label asp-for="StreetAddress" class="form-label fw-bold small text-amazon-dark mb-1">Street Address</label>
                        <input asp-for="StreetAddress" class="form-control amazon-input-field" />
                        <span asp-validation-for="StreetAddress" class="text-danger small mt-1 d-block"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="City" class="form-label fw-bold small text-amazon-dark mb-1">City</label>
                                <input asp-for="City" class="form-control amazon-input-field" />
                                <span asp-validation-for="City" class="text-danger small mt-1 d-block"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label asp-for="State" class="form-label fw-bold small text-amazon-dark mb-1">State/Province</label>
                                <input asp-for="State" class="form-control amazon-input-field" />
                                <span asp-validation-for="State" class="text-danger small mt-1 d-block"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-4">
                                <label asp-for="PostalCode" class="form-label fw-bold small text-amazon-dark mb-1">Postal Code</label>
                                <input asp-for="PostalCode" class="form-control amazon-input-field" />
                                <span asp-validation-for="PostalCode" class="text-danger small mt-1 d-block"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-4">
                                <label asp-for="Country" class="form-label fw-bold small text-amazon-dark mb-1">Country</label>
                                <input asp-for="Country" class="form-control amazon-input-field" />
                                <span asp-validation-for="Country" class="text-danger small mt-1 d-block"></span>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid mt-2 mb-3">
                        <button type="submit" id="submitBtn" class="btn btn-amazon-checkout w-100 fw-bold">
                            Create your CMSECommerce account
                        </button>
                    </div>

                    <p class="small text-muted mb-4 text-center">
                        By creating an account, you agree to CMSECommerce's <a href="#" class="text-amazon-link">Conditions of Use</a> and <a href="#" class="text-amazon-link">Privacy Notice</a>.
                    </p>

                    <hr />
                    <p class="text-center mt-3 mb-0 small text-muted">
                        Already have an account?
                        <a asp-controller="Account" asp-action="Login" class="text-amazon-link fw-semibold">Sign in</a>.
                    </p>
                </form>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        :root {
            --amazon-dark-text: #0F1111;
            --amazon-yellow-action: #FFD814;
            --amazon-yellow-action-hover: #F7CA00;
            --amazon-link-teal: #007185;
            --amazon-link-teal-hover: #C7511F;
            --amazon-page-bg: #f7f7f7;
            --amazon-error-red: #c40000;
        }

        .amazon-login-page {
            background-color: var(--amazon-page-bg);
            min-height: 100vh;
        }

        .text-amazon-dark {
            color: var(--amazon-dark-text);
        }

        .text-amazon-link {
            color: var(--amazon-link-teal) !important;
            text-decoration: none;
        }

            .text-amazon-link:hover {
                color: var(--amazon-link-teal-hover) !important;
                text-decoration: underline;
            }

        .amazon-form-box {
            max-width: 400px;
            border-color: #ddd !important;
            background-color: #fff;
        }

        .amazon-input-field {
            height: 31px;
            padding: 3px 7px;
            font-size: 14px;
            border-radius: 3px;
            border: 1px solid #a6a6a6;
            box-shadow: 0 1px 0 rgba(0,0,0,.04);
        }

            .amazon-input-field:focus {
                border-color: #e77600;
                box-shadow: 0 0 3px 2px rgba(228,121,17,.5);
                outline: none;
            }

        .input-error-border {
            border-color: var(--amazon-error-red) !important;
            box-shadow: 0 0 3px rgba(196, 0, 0, 0.5) !important;
        }

        .btn-amazon-checkout {
            background-color: var(--amazon-yellow-action) !important;
            border: 1px solid #FCD200 !important;
            color: var(--amazon-dark-text) !important;
            border-radius: 7px !important;
            height: 35px;
            font-size: 13px;
        }

            .btn-amazon-checkout:hover {
                background-color: var(--amazon-yellow-action-hover) !important;
            }

            .btn-amazon-checkout:disabled {
                background-color: #f0f2f2 !important;
                border-color: #d5d9d9 !important;
                color: #a6a6a6 !important;
                cursor: not-allowed;
            }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            const userNameInput = $('#UserNameInput');
            const emailInput = $('#EmailInput');
            const phoneInput = $('#PhoneInput');
            const submitBtn = $('#submitBtn');

            function checkUniqueness(inputElement, errorElement, url, dataParamName, defaultErrorMessage) {
                const value = inputElement.val().trim();

                // 1. Client-side Format Validation (Fail-Fast)
                if (value !== "") {
                    // Email Regex check
                    if (dataParamName === 'email') {
                        const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
                        if (!emailRegex.test(value)) {
                            setError(inputElement, errorElement, "Please enter a valid email address.");
                            return;
                        }
                    }

                    // Phone Numeric/Length check
                    if (dataParamName === 'phoneNumber') {
                        if (value.length !== 10 || isNaN(value)) {
                            setError(inputElement, errorElement, "Please enter a valid 10-digit numeric mobile number.");
                            return;
                        }
                    }
                }

                // 2. Empty Value Handling
                if (value === "") {
                    clearError(inputElement, errorElement);
                    return;
                }

                // 3. Server-side AJAX Check
                $.ajax({
                    url: url,
                    type: 'GET',
                    data: { [dataParamName]: value },
                    success: function (response) {
                        // Support both raw boolean and { isAvailable, message } object
                        const isAvailable = typeof response === 'object' ? response.isAvailable : response;
                        const serverMsg = typeof response === 'object' ? response.message : null;

                        if (!isAvailable) {
                            setError(inputElement, errorElement, serverMsg || defaultErrorMessage);
                        } else {
                            clearError(inputElement, errorElement);
                        }
                    },
                    error: function() {
                        console.error("Validation service unavailable for " + dataParamName);
                    }
                });
            }

            function setError(input, errorSpan, msg) {
                errorSpan.text(msg);
                input.addClass("input-error-border");
                updateButtonState();
            }

            function clearError(input, errorSpan) {
                errorSpan.text("");
                input.removeClass("input-error-border");
                updateButtonState();
            }

            function updateButtonState() {
                const hasErrors = $(".input-error-border").length > 0;
                submitBtn.prop("disabled", hasErrors);
            }

            // Event Listeners
            userNameInput.on("blur", function () {
                checkUniqueness(userNameInput, $('#UserNameError'), '@Url.Action("CheckUserNameUnique", "Account")', 'userName', "This username is already taken.");
            });

            emailInput.on("blur", function () {
                checkUniqueness(emailInput, $('#EmailError'), '@Url.Action("CheckEmailUnique", "Account")', 'email', "Email address is already in use.");
            });

            phoneInput.on("blur", function () {
                checkUniqueness(phoneInput, $('#PhoneError'), '@Url.Action("CheckPhoneUnique", "Account")', 'phoneNumber', "This number is already registered with another user.");
            });

            $('#registrationForm').on("submit", function(e) {
                if ($(".input-error-border").length > 0) {
                    e.preventDefault();
                    alert("Please fix the highlighted errors before proceeding.");
                }
            });
        });
    </script>
}