@model CMSECommerce.Models.ViewModels.RegisterViewModel

@{
    ViewData["Title"] = "Create Account";
}

<div class="amazon-login-page py-5">
    <div class="container d-flex justify-content-center">
        <div style="width: 100%; max-width: 400px;">

            <div class="amazon-form-box p-4 border rounded shadow-sm bg-white">
                <h1 class="h3 fw-bold mb-4 text-amazon-dark">Create account</h1>

                <form asp-action="Register" method="post" id="registrationForm" novalidate>
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger small p-2" role="alert"></div>

                    @* --- Username --- *@
                    <div class="form-group mb-3">
                        <label asp-for="Username" class="form-label fw-bold small text-amazon-dark mb-1">User Name</label>
                        <input asp-for="Username" id="UserInput" class="form-control amazon-input-field" placeholder="Unique username" />
                        <span asp-validation-for="Username" id="UserError" class="text-danger small mt-1 d-block"></span>
                    </div>

                    @* --- Email --- *@
                    <div class="form-group mb-3">
                        <label asp-for="Email" class="form-label fw-bold small text-amazon-dark mb-1">Email</label>
                        <input asp-for="Email" id="EmailInput" class="form-control amazon-input-field" type="email" placeholder="example@domain.com" />
                        <span asp-validation-for="Email" id="EmailError" class="text-danger small mt-1 d-block"></span>
                    </div>

                    @* --- Mobile Number --- *@
                    <div class="form-group mb-3">
                        <label asp-for="PhoneNumber" class="form-label fw-bold small text-amazon-dark mb-1">Mobile Number</label>
                        <input asp-for="PhoneNumber" id="PhoneInput" class="form-control amazon-input-field" placeholder="10-digit mobile" maxlength="10" inputmode="numeric" />
                        <span asp-validation-for="PhoneNumber" id="PhoneError" class="text-danger small mt-1 d-block"></span>
                    </div>

                    @* --- Password --- *@
                    <div class="form-group mb-3">
                        <label asp-for="Password" class="form-label fw-bold small text-amazon-dark mb-1">Password</label>
                        <input asp-for="Password" id="PassInput" type="password" class="form-control amazon-input-field" placeholder="At least 6 characters" />
                        <span asp-validation-for="Password" class="text-danger small mt-1 d-block"></span>
                        <div class="small text-muted mt-1"><i class="fas fa-info-circle me-1 text-primary"></i> Passwords must be at least 6 characters.</div>
                    </div>

                    @* --- Confirm Password --- *@
                    <div class="form-group mb-3">
                        <label asp-for="ConfirmPassword" class="form-label fw-bold small text-amazon-dark mb-1">Re-enter password</label>
                        <input asp-for="ConfirmPassword" id="ConfirmPassInput" type="password" class="form-control amazon-input-field" />
                        <span asp-validation-for="ConfirmPassword" id="ConfirmPassError" class="text-danger small mt-1 d-block"></span>
                    </div>

                    <div class="d-grid mt-4 mb-3">
                        <button type="submit" id="submitBtn" class="btn btn-amazon-checkout w-100 fw-bold">
                            Continue
                        </button>
                    </div>

                    <p class="small text-muted mb-4 text-center">
                        By creating an account, you agree to CMSECommerce's <a href="#" class="text-amazon-link">Conditions of Use</a> and <a href="#" class="text-amazon-link">Privacy Notice</a>.
                    </p>

                    <hr />
                    <div class="text-center small">
                        Already have an account? <a asp-action="Login" class="text-amazon-link fw-bold">Sign in <i class="fas fa-caret-right"></i></a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        :root {
            --amazon-dark-text: #0F1111;
            --amazon-yellow: #FFD814;
            --amazon-yellow-hover: #F7CA00;
            --amazon-error: #c40000;
            --amazon-link: #0066c0;
        }

        .amazon-login-page {
            background-color: #fff;
            min-height: 100vh;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        .text-amazon-dark {
            color: var(--amazon-dark-text);
        }

        .text-amazon-link {
            color: var(--amazon-link);
            text-decoration: none;
        }

            .text-amazon-link:hover {
                color: #c45500;
                text-decoration: underline;
            }

        .amazon-form-box {
            border-color: #ddd !important;
            border-radius: 8px !important;
        }

        .amazon-input-field {
            height: 31px;
            font-size: 13px;
            border-radius: 3px;
            border: 1px solid #a6a6a6;
            padding: 3px 7px;
        }

            .amazon-input-field:focus {
                border-color: #e77600;
                box-shadow: 0 0 3px 2px rgba(228,121,17,.5);
                outline: none;
            }

        .input-error-border {
            border-color: var(--amazon-error) !important;
            box-shadow: 0 0 3px rgba(196, 0, 0, 0.5) !important;
        }

        .btn-amazon-checkout {
            background-color: var(--amazon-yellow) !important;
            border: 1px solid #FCD200 !important;
            box-shadow: 0 2px 5px 0 rgba(213,217,217,.5);
            color: #0F1111 !important;
            border-radius: 8px !important;
            padding: 5px 0;
        }

            .btn-amazon-checkout:hover {
                background-color: var(--amazon-yellow-hover) !important;
                border-color: #F2C200 !important;
            }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            // 1. Numerical Input Only for Phone
            $('#PhoneInput').on('input', function () {
                this.value = this.value.replace(/\D/g, '');
            });

            // 2. Field Map for Validation
            const fields = [
                { id: $('#UserInput'), err: $('#UserError'), type: 'Username' },
                { id: $('#EmailInput'), err: $('#EmailError'), type: 'Email' },
                { id: $('#PhoneInput'), err: $('#PhoneError'), type: 'Mobile Number' },
                { id: $('#ConfirmPassInput'), err: $('#ConfirmPassError'), type: 'ConfirmPassword' }
            ];

            function validateField(field) {
                const val = field.id.val().trim();
                if (val === "") return;

                // Password Matching Logic
                if (field.type === 'ConfirmPassword') {
                    const password = $('#PassInput').val();
                    if (val !== password) {
                        setError(field.id, field.err, "Passwords must match.");
                        return;
                    } else {
                        clearError(field.id, field.err);
                        return;
                    }
                }

                // Mobile Format Check
                if (field.type === 'Mobile Number' && !/^[6-9]\d{9}$/.test(val)) {
                    setError(field.id, field.err, "Enter a valid 10-digit mobile number.");
                    return;
                }

                // AJAX Uniqueness Check for Identity Fields
                $.ajax({
                    url: '@Url.Action("ValidateIdentifier", "Account")',
                    type: 'GET',
                    data: { value: val, type: field.type },
                    success: function (res) {
                        if (!res.isAvailable) {
                            setError(field.id, field.err, res.message);
                        } else {
                            clearError(field.id, field.err);
                        }
                    }
                });
            }

            // Bind blur event to all fields in map
            fields.forEach(f => {
                f.id.on('blur', () => validateField(f));
            });

            // Help functions for UI feedback
            function setError(input, span, msg) {
                span.text(msg);
                input.addClass("input-error-border");
                $('#submitBtn').prop("disabled", true);
            }

            function clearError(input, span) {
                span.text("");
                input.removeClass("input-error-border");
                // Only re-enable if NO other fields have errors
                $('#submitBtn').prop("disabled", $(".input-error-border").length > 0);
            }
        });
    </script>
}