@model IEnumerable<CMSECommerce.Models.SubscriptionRequest>

@{
    ViewData["Title"] = "My Subscription Status";
    var profile = (CMSECommerce.Models.UserProfile)ViewBag.UserProfile;
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">

            @* --- CURRENT STATUS HEADER (Always Visible) --- *@
            @if (profile != null && profile.SubscriptionEndDate.HasValue)
            {
                var timeLeft = profile.SubscriptionEndDate.Value - DateTime.Now;
                var totalDuration = (profile.SubscriptionEndDate.Value - profile.SubscriptionStartDate.Value).TotalSeconds;
                var remainingSecs = Math.Max(0, (profile.SubscriptionEndDate.Value - DateTime.Now).TotalSeconds);
                var displayPercent = Math.Max(0, Math.Min(100, (remainingSecs / totalDuration) * 100));
                var remainingDays = timeLeft.TotalDays;

                <div class="card shadow-sm border-0 mb-5 bg-white border-start border-4 border-primary">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="fw-bold mb-0 text-dark">Current Subscription Status</h4>
                            @if (timeLeft.TotalSeconds > 0)
                            {
                                <span class="badge bg-success px-3 py-2">ACTIVE PLAN</span>
                            }
                            else
                            {
                                <span class="badge bg-danger px-3 py-2">EXPIRED</span>
                            }
                        </div>

                        <div class="progress mb-2" style="height: 18px; background-color: #e9ecef;">
                            @{
                                string barColor = "bg-success";
                                if (remainingDays <= 5) { barColor = "bg-danger"; }
                                else if (remainingDays <= 10) { barColor = "bg-warning"; }
                            }
                            <div class="progress-bar progress-bar-striped progress-bar-animated @barColor"
                                 role="progressbar"
                                 style="width: @displayPercent.ToString("0")%">
                            </div>
                        </div>

                        <div class="d-flex justify-content-between small fw-bold mt-2">
                            <span class="text-muted">Started: @profile.SubscriptionStartDate.Value.ToString("dd MMM yyyy")</span>
                            <span class="@(remainingDays <= 5 ? "text-danger" : "text-success")">
                                <i class="fas fa-clock me-1"></i>
                                Expires: @profile.SubscriptionEndDate.Value.ToString("dd MMM yyyy")
                                (@(remainingDays > 0 ? $"{(int)remainingDays} days remaining" : "Access Ended"))
                            </span>
                        </div>
                    </div>
                </div>
            }

            <h2 class="mb-4 text-center fw-bold">Subscription History</h2>

            @if (!Model.Any())
            {
                <div class="alert alert-info text-center shadow-sm py-5">
                    <i class="fas fa-history fa-3x mb-3 text-secondary"></i>
                    <p class="fs-5">You haven't submitted any subscription requests yet.</p>
                    <a asp-action="Index" class="btn btn-primary btn-lg px-5">Browse Plans</a>
                </div>
            }
            else
            {
                <div class="list-group">
                    @foreach (var request in Model.OrderByDescending(r => r.CreatedAt))
                    {
                        @* ID is used by JS to track status changes *@
                        <div class="subscription-request list-group-item p-4 mb-4 shadow-sm border rounded bg-white"
                             data-id="@request.Id"
                             data-status="@request.Status">

                            <div class="d-flex w-100 justify-content-between align-items-center mb-3">
                                <h5 class="mb-0 fw-bold text-dark">
                                    <i class="fas fa-gem me-2 text-primary"></i>@request.Tier.Name Package
                                </h5>
                                <small class="text-muted bg-light px-2 py-1 rounded">
                                    <i class="far fa-calendar-alt me-1"></i>Submitted: @request.CreatedAt.ToString("dd MMM yyyy")
                                </small>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="p-3 border rounded bg-light h-100">
                                        <p class="mb-2 text-secondary small text-uppercase fw-bold">Payment Details</p>
                                        <p class="mb-2"><strong>ITS:</strong> <code class="text-primary">@request.ItsNumber</code></p>
                                        <div class="mt-3">
                                            @if (request.Status == RequestStatus.Pending)
                                            {
                                                <span class="badge bg-warning text-dark border w-100 py-2">
                                                    <i class="fas fa-hourglass-half me-1"></i> PENDING REVIEW
                                                </span>
                                            }
                                            else if (request.Status == RequestStatus.Approved)
                                            {
                                                <span class="badge bg-success w-100 py-2">
                                                    <i class="fas fa-check-circle me-1"></i> APPROVED
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger w-100 py-2">
                                                    <i class="fas fa-times-circle me-1"></i> REJECTED
                                                </span>
                                            }
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-8">
                                    @if (request.Status == RequestStatus.Pending)
                                    {
                                        <div class="alert alert-warning border-warning h-100 mb-0 d-flex align-items-center">
                                            <div>
                                                <h6 class="fw-bold"><i class="fas fa-sync fa-spin me-2"></i>Under Verification</h6>
                                                <p class="small mb-0">The admin is currently verifying your payment. This page will update automatically once approved.</p>
                                            </div>
                                        </div>
                                    }
                                    else if (request.Status == RequestStatus.Approved)
                                    {
                                        <div class="alert alert-success h-100 mb-0 border-success d-flex flex-column justify-content-center">
                                            <p class="mb-2"><i class="fas fa-shield-check me-2"></i><strong>Success!</strong> Your seller account is now active.</p>
                                            <a href="/Seller/Dashboard" class="btn btn-sm btn-success align-self-start mt-2 px-4">
                                                <i class="fas fa-tachometer-alt me-1"></i> Go to Seller Dashboard
                                            </a>
                                        </div>
                                    }
                                    else if (request.Status == RequestStatus.Rejected)
                                    {
                                        <div class="alert alert-danger h-100 mb-0 border-danger">
                                            <h6 class="fw-bold"><i class="fas fa-ban me-2"></i>Request Declined</h6>
                                            <p class="small mb-2"><strong>Reason:</strong> @request.RejectionReason</p>
                                            <a asp-action="Index" class="btn btn-sm btn-danger mt-2">
                                                <i class="fas fa-redo me-1"></i> Fix & Resubmit
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <style>
        body {
            background-color: #f4f7f6;
        }

        .progress {
            border-radius: 10px;
            overflow: hidden;
        }

        .list-group-item {
            transition: none !important;
            border-left: 1px solid #dee2e6 !important;
        }

        .badge {
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .alert {
            border-radius: 8px;
        }
    </style>
}

@section Scripts {
    <script>
        /**
         * AUTO-REFRESH SCRIPT
         * Polls the server to see if the status of any "Pending" request has changed.
         */
        $(document).ready(function () {
            // Only run the poller if there is at least one "Pending" request on the screen
            const hasPending = $('.subscription-request[data-status="Pending"]').length > 0;

            if (hasPending) {
                console.log("Pending request detected. Auto-refresh poller started...");

                // Poll every 10 seconds
                const pollInterval = setInterval(function () {
                    // We call a lightweight endpoint that returns the user's latest request statuses
                    // Replace "/Subscription/GetLatestStatuses" with your actual API endpoint
                    $.getJSON('/Subscription/GetLatestStatuses', function (data) {
                        let refreshNeeded = false;

                        // data should be an array like: [{ id: 1, status: "Approved" }, ...]
                        data.forEach(item => {
                            const row = $(`.subscription-request[data-id="${item.id}"]`);
                            const oldStatus = row.attr('data-status');

                            // If the status on server is different than status on UI, reload
                            if (oldStatus && oldStatus !== item.status) {
                                refreshNeeded = true;
                            }
                        });

                        if (refreshNeeded) {
                            console.log("Status change detected! Reloading...");
                            location.reload();
                        }
                    });
                }, 10000);
            }
        });
    </script>
}