@model CMSECommerce.Models.UserProfile
@{
    ViewData["Title"] = "User Subscription Details";
    var history = ViewBag.History as IEnumerable<CMSECommerce.Models.SubscriptionRequest>;
    var totalSpent = ViewBag.TotalSpent;
    ViewData["HideLayoutSidebar"] = true;
}

@section Styles {
    <style>
        .detail-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #718096;
            font-weight: 700;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
        }

        /* Timeline UI */
        .timeline {
            position: relative;
            padding: 20px 0;
            list-style: none;
        }

            .timeline:before {
                content: '';
                position: absolute;
                top: 0;
                bottom: 0;
                width: 2px;
                background: #e2e8f0;
                left: 20px;
            }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 50px;
        }

        .timeline-marker {
            position: absolute;
            left: 13px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #cbd5e0;
            border: 3px solid #fff;
        }

        .status-Approved {
            background: #48bb78;
        }

        .status-Pending {
            background: #ed8936;
        }

        .status-Rejected {
            background: #f56565;
        }
    </style>
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a asp-action="AdminDashboard" class="btn btn-sm btn-outline-secondary mb-2">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <h2 class="h4 fw-bold">User Portfolio: @Model.User.UserName</h2>
        </div>
        <div class="text-end">
            <span class="badge @(Model.SubscriptionEndDate > DateTime.Now ? "bg-success" : "bg-secondary") py-2 px-3">
                @(Model.SubscriptionEndDate > DateTime.Now ? "ACTIVE SUBSCRIBER" : "INACTIVE")
            </span>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-4">
            <div class="card detail-card p-4 mb-4">
                <div class="stat-label">Total Contribution</div>
                @* Updated to Indian Rupee Symbol and Formatting *@
                <div class="stat-value text-primary">₹@string.Format("{0:N2}", totalSpent)</div>
                <hr>
                <div class="stat-label">Current Plan</div>
                <div class="stat-value">@(Model.CurrentTierId.HasValue ? $"Tier {Model.CurrentTierId}" : "No Active Tier")</div>
                <hr>
                <div class="stat-label">Expiry Date</div>
                <div class="stat-value text-danger">@(Model.SubscriptionEndDate?.ToString("MMM dd, yyyy") ?? "N/A")</div>
            </div>

            <div class="card detail-card p-4">
                <h6 class="fw-bold mb-3">Identity Details</h6>
                <div class="mb-2">
                    <div class="stat-label">ITS Number</div>
                    <div class="fw-bold">@history.FirstOrDefault()?.ItsNumber</div>
                </div>
                <div>
                    <div class="stat-label">User ID</div>
                    <code class="text-xs">@Model.UserId</code>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card detail-card p-4">
                <h6 class="fw-bold mb-4"><i class="fas fa-history me-2 text-muted"></i>Subscription Timeline</h6>

                <ul class="timeline">
                    @foreach (var req in history)
                    {
                        <li class="timeline-item">
                            <div class="timeline-marker status-@req.Status"></div>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <span class="fw-bold">@req.Tier.Name Plan</span>
                                    @if (req.IsUpgrade)
                                    {
                                        <span class="badge bg-info text-white ms-1" style="font-size:0.6rem;">UPGRADE</span>
                                    }
                                    <div class="text-xs text-muted">Submitted on @req.CreatedAt.ToString("MMM dd, yyyy hh:mm tt")</div>
                                </div>
                                <div class="text-end">
                                    <div class="badge-status @(req.Status == RequestStatus.Approved ? "text-success" : "text-danger") fw-bold">@req.Status</div>
                                    @if (req.Status == RequestStatus.Approved)
                                    {
                                        @* Updated to Indian Rupee Symbol *@
                                        <div class="text-xs text-success">+₹@string.Format("{0:N2}", req.Tier.Price)</div>
                                    }
                                </div>
                            </div>
                            @if (!string.IsNullOrEmpty(req.RejectionReason))
                            {
                                <div class="alert alert-danger py-1 px-2 mt-2 text-xs">Reason: @req.RejectionReason</div>
                            }
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>