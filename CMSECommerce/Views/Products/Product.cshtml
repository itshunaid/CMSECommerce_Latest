@model Product
@* Assuming Product model has Name, Slug, Image, Price, Description, Id, and GalleryImages, and StockQuantity (int). *@

@{
    ViewData["Title"] = Model.Name;
    // Prepare a list of all image paths for the gallery
    var allImages = new List<string>();

    // 1. Add the main image if it exists
    var mainImagePath = $"/media/products/{Model.Image}";
    if (!string.IsNullOrEmpty(Model.Image))
    {
        allImages.Add(mainImagePath);
    }

    // 2. Add gallery images
    if (Model.GalleryImages?.Any() == true)
    {
        allImages.AddRange(Model.GalleryImages.Select(image => $"/media/gallery/{Model.Id}/{image}"));
    }

    // Fallback in case no images are available
    var defaultImagePath = "/media/default-product.png"; // Set a proper default image path
    if (!allImages.Any())
    {
        allImages.Add(defaultImagePath);
    }

    // Determine Stock Status for logic/design
    var isInStock = Model.StockQuantity > 0;

    // --- Placeholder for Related Products (Replace with real data source) ---
    // Create dummy related products for demonstration of the card component
    var RelatedProducts = new List<Product>
    {
        new Product { Id = 101, Name = "Related Item A", Slug = "related-item-a", Image = "related-a.jpg", Price = 19.99m, StockQuantity = 5 },
        new Product { Id = 102, Name = "Related Item B - Longer Name to Clamp", Slug = "related-item-b", Image = "related-b.jpg", Price = 45.00m, StockQuantity = 0 },
        new Product { Id = 103, Name = "Related Item C", Slug = "related-item-c", Image = "related-c.jpg", Price = 99.50m, StockQuantity = 12 },
        new Product { Id = 104, Name = "Related Item D - Last One", Slug = "related-item-d", Image = "related-d.jpg", Price = 7.75m, StockQuantity = 1 },
    };
    // Note: In a real application, you would fetch RelatedProducts from the database.
}

<div class="container py-5">

    @* --- Breadcrumb Navigation --- *@
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-light p-2 rounded-3">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index" class="text-decoration-none text-muted">Home</a></li>
            @* NOTE: You should ideally pass Category Name/Slug in your Product Model or ViewData *@
            <li class="breadcrumb-item"><a href="/products" class="text-decoration-none text-muted">Category Name</a></li>
            <li class="breadcrumb-item active fw-bold" aria-current="page">@Model.Name</li>
        </ol>
    </nav>

    <div class="row">

        @* --- Left Column: Images & Gallery --- *@
        <div class="col-lg-6 col-md-6 mb-4">

            <div class="main-image-area border rounded p-3 bg-white shadow-lg">
                @* Main Image Link for FancyBox *@
                <a href="@allImages.First()" data-fancybox="gallery-main" class="d-block text-center" id="main-image-link">
                    <img id="main-product-img"
                         src="@allImages.First()"
                         class="img-fluid rounded"
                         alt="@Model.Name - Main View"
                         style="max-height: 500px; width: 100%; object-fit: contain;" />
                </a>
            </div>

            @* --- Thumbnail Gallery (Visible only if more than one image) --- *@
            @if (allImages.Count > 1)
            {
                <h6 class="mt-4 mb-2 text-muted small fw-bold text-uppercase">More Views</h6>
                <div class="row g-2 justify-content-start thumbnail-gallery">

                    @foreach (var imagePath in allImages)
                    {
                        <div class="col-3 col-sm-2">
                            <a href="@imagePath" data-fancybox="gallery-main" class="d-block thumbnail-link"
                               data-image-url="@imagePath" title="View product image">
                                <img class="img-fluid border rounded thumbnail-image"
                                     src="@imagePath"
                                     alt="Product Thumbnail" style="height: 60px; object-fit: cover; width: 100%;" />
                            </a>
                        </div>
                    }
                </div>
            }
        </div>

        @* --- Right Column: Product Info & CTA --- *@
        <div class="col-lg-6 col-md-6">

            <h1 class="display-5 fw-bolder mb-2 text-dark">@Model.Name</h1>

            @* --- Ratings Block --- *@
            <div class="mb-4">
                <span class="text-warning fs-5" aria-label="4.5 out of 5 stars">
                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i><i class="far fa-star"></i>
                </span>
                <span class="text-muted ms-2">(<a href="#reviews" class="text-decoration-none small">128 Reviews</a>)</span>
            </div>

            @* --- Pricing and Add to Cart (Sticky for Conversion) --- *@
            <div class="sticky-top" style="top: 20px;">

                <div class="card bg-light p-4 mb-4 border-0 shadow-lg">
                    <div class="card-body p-0">

                        <p class="mb-1 text-muted small fw-bold text-uppercase">Price</p>
                        <h2 class="card-title text-primary fw-bolder mb-4 display-3">
                            @Model.Price.ToString("C2")
                        </h2>

                        <form asp-controller="Cart" asp-action="Add" method="post" class="needs-validation" novalidate>
                            <input type="hidden" name="id" value="@Model.Id" />

                            <div class="d-flex align-items-center mb-4">
                                <label for="quantityInput" class="form-label me-3 mb-0 fw-bold">Quantity:</label>

                                @* Conditional disable for quantity input *@
                                <input type="number" name="quantity" id="quantityInput" value="1"
                                       min="1" max="@(isInStock? Model.StockQuantity: 0)"
                                       class="form-control me-3 text-center" style="width: 80px;" required
                                       aria-label="Product Quantity" @(!isInStock ? "disabled" : "") />

                                @* Conditional button display/disable *@
                                @if (isInStock)
                                {
                                    <button type="submit" class="btn btn-primary btn-lg flex-grow-1 shadow">
                                        <i class="fas fa-cart-plus me-2"></i> Add to Cart
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-danger btn-lg flex-grow-1 shadow" disabled>
                                        <i class="fas fa-times-circle me-2"></i> Out of Stock
                                    </button>
                                }
                            </div>
                        </form>

                        @* --- Policy/Trust Badges (UPDATED STOCK LOGIC) --- *@
                        <div class="border-top pt-3">

                            @if (isInStock)
                            {
                                <p class="small text-dark mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span class="fw-bold">In Stock</span> (@Model.StockQuantity left, ready to ship)
                                </p>
                            }
                            else
                            {
                                <p class="small text-dark mb-2 text-danger">
                                    <i class="fas fa-times-circle me-2"></i>
                                    <span class="fw-bold">Out of Stock</span> (Check back soon)
                                </p>
                            }

                            <ul class="list-unstyled small text-muted">
                                <li class="mb-1">
                                    <i class="fas fa-truck me-2 text-info"></i> **Free Shipping** on orders over $50
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-undo-alt me-2 text-info"></i> **30-Day Returns** for a full refund.
                                </li>
                                <li>
                                    <i class="fas fa-lock me-2 text-info"></i> **Secure Checkout** Guaranteed.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                @* --- Short Features List --- *@
                <div class="card shadow-sm p-3 mb-4 border-0 bg-white">
                    <h6 class="text-dark fw-bold mb-2 text-uppercase small">Highlights</h6>
                    <ul class="list-unstyled mb-0 small text-dark">
                        <li><i class="fas fa-medal text-success me-2"></i> Premium Quality Material</li>
                        <li><i class="fas fa-mobile-alt text-success me-2"></i> Designed for Durability</li>
                        <li><i class="fas fa-wrench text-success me-2"></i> Easy Setup and Maintenance</li>
                        @* Add dynamic features here if available in Model *@
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-5" />

    @* --- Full Description, Specs, and Reviews (Tabs) --- *@
    <div class="row">
        <div class="col-12">

            <ul class="nav nav-tabs" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="description" aria-selected="true"><i class="fas fa-file-alt me-2"></i> Full Description</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="specifications-tab" data-bs-toggle="tab" data-bs-target="#specifications" type="button" role="tab" aria-controls="specifications" aria-selected="false"><i class="fas fa-list me-2"></i> Specifications</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab" aria-controls="reviews" aria-selected="false"><i class="fas fa-comments me-2"></i> Customer Reviews (128)</button>
                </li>
            </ul>

            <div class="tab-content border border-top-0 p-4 bg-white shadow-sm" id="productTabsContent">

                <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
                    <div class="product-description-content text-dark">
                        @Html.Raw(Model.Description)
                    </div>
                </div>

                <div class="tab-pane fade" id="specifications" role="tabpanel" aria-labelledby="specifications-tab">
                    <h5 class="mb-3">Technical Details</h5>
                    <table class="table table-striped table-bordered">
                        <tbody>
                            <tr>
                                <th style="width: 30%;">Product ID</th>
                                <td>@Model.Id</td>
                            </tr>
                            @* --- Add more dynamic specifications from Model here --- *@
                            <tr>
                                <th>Weight</th>
                                <td>5.2 lbs</td> @* Placeholder Value *@
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                    <h5 class="mb-3">Customer Feedback & Rating Breakdown</h5>
                    <p class="text-muted">This is where customer reviews and ratings would be dynamically loaded, allowing users to trust the product through social proof.</p>
                    <button class="btn btn-primary mt-3"><i class="fas fa-pen me-1"></i> Write a Review</button>
                </div>

            </div>

        </div>
    </div>

    <hr class="my-5" />

    @* 🚀 --- Related Products (PROFESSIONAL CARD GRID) --- 🚀 *@
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="fw-bolder">You May Also Like...</h3>
            <p class="text-muted">Explore similar products or frequently bought together items.</p>

            <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-4 mt-3">

                @if (RelatedProducts.Any())
                {
                    @foreach (var product in RelatedProducts.Take(4)) @* Limit to 4 for a clean row on large screens *@
                    {
                        var relatedImagePath = !string.IsNullOrEmpty(product.Image)
                        ? $"/media/products/{product.Image}"
                        : defaultImagePath;
                        var productUrl = $"/{product.Slug}";
                        var relatedIsInStock = product.StockQuantity > 0;

                        <div class="col">
                            <div class="card h-100 border-0 shadow-sm transition-hover">
                                <a href="@productUrl" class="text-decoration-none d-block overflow-hidden">
                                    <img src="@relatedImagePath" class="card-img-top" alt="@product.Name" style="height: 180px; object-fit: cover;">
                                </a>
                                <div class="card-body p-3">
                                    <h5 class="card-title mb-1">
                                        <a href="@productUrl" class="text-dark fw-bold small-title-clamp" title="@product.Name">
                                            @product.Name
                                        </a>
                                    </h5>
                                    <div class="text-warning small mb-2">
                                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i><i class="far fa-star"></i>
                                        <span class="text-muted ms-1 small">(12)</span>
                                    </div>
                                    <p class="card-text text-primary fw-bolder fs-5">
                                        @product.Price.ToString("C2")
                                    </p>
                                </div>
                                <div class="card-footer bg-transparent border-0 pt-0 pb-3 px-3">
                                    @if (relatedIsInStock)
                                    {
                                        <a href="/cart/add/@product.Id" class="btn btn-sm btn-outline-primary w-100">
                                            <i class="fas fa-shopping-cart me-1"></i> Add to Cart
                                        </a>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-danger w-100" disabled>
                                            Out of Stock
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12"><p class="text-muted">No related products found at this time.</p></div>
                }

            </div>

        </div>
    </div>

</div>

@section Scripts {
    @* NOTE: Replace with your actual Font Awesome kit or CDN *@
    <script src="https://kit.fontawesome.com/your-fontawesome-kit-id.js" crossorigin="anonymous"></script>
    @* Assuming you've included the jQuery and FancyBox scripts globally or via another section *@
    <script src="~/lib/fancybox/jquery.fancybox.min.js"></script>

    @* --- Thumbnail Swap Logic (UNMODIFIED FUNCTIONALITY) --- *@
    <script>
        $(document).ready(function() {
            // Initialize FancyBox for all images in the gallery group
            $('[data-fancybox="gallery-main"]').fancybox({
                buttons: ["zoom", "slideShow", "close"],
            });

            // Thumbnail Click-to-Swap Functionality (UX Improvement)
            $('.thumbnail-gallery').on('click', '.thumbnail-link', function(e) {
                e.preventDefault(); // Prevent opening FancyBox immediately

                const imageUrl = $(this).data('image-url');
                const mainImage = $('#main-product-img');
                const mainImageLink = $('#main-image-link');

                // Update the main <img> source
                mainImage.attr('src', imageUrl);

                // Update the main <a> link for FancyBox
                mainImageLink.attr('href', imageUrl);

                // Update the active thumbnail styling
                $('.thumbnail-link').removeClass('active-thumbnail');
                $(this).addClass('active-thumbnail');
            });

            // Auto-click the first thumbnail to ensure the main image and active style are set correctly on load
            // This is crucial if the main image path is the same as the first thumbnail path
            $('.thumbnail-link:first').addClass('active-thumbnail');
        });
    </script>

    @* --- Custom Styles (Minor Refinements) --- *@
    <style>
        .sticky-top {
            z-index: 100;
        }

        /* Adjusted price display for prominence */
        .card-title.display-3 {
            color: var(--bs-primary) !important;
            font-size: 3rem !important; /* Slightly larger than standard display-4/5 */
        }

        .thumbnail-link.active-thumbnail img {
            border: 2px solid var(--bs-primary) !important;
            box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
            opacity: 1;
        }

        .thumbnail-image {
            transition: all 0.2s;
            cursor: pointer;
        }

            .thumbnail-image:hover {
                opacity: 0.8;
            }

        .product-description-content h2, .product-description-content h3 {
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
            font-weight: 600;
        }

        /* Ensure product image doesn't stretch awkwardly if tall */
        .main-image-area img {
            height: auto;
        }

        /* --- New styles for Related Products Cards (Improved Hover) --- */
        .transition-hover {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

            .transition-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15) !important;
            }

        /* Limit product title to two lines for consistent card height */
        .small-title-clamp {
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Number of lines to show */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.4em; /* Approx height of 2 lines */
            line-height: 1.2em;
            font-size: 0.95rem !important;
        }
    </style>
}