@model ProductListViewModel

@{
    ViewData["Title"] = "Weypaari";

    // Accessing properties via the View Model
    var categoryName = Model.CategoryName;
    var currentSearchTerm = Model.CurrentSearchTerm;

    // Keeping original ViewBags for properties not included in the simplified VM
    var currentCategorySlug = ViewBag.CategorySlug as string;
    var currentPage = (int)(ViewBag.PageNumber ?? 1);
    var totalPages = (int)(ViewBag.TotalPages ?? 1);
    var sortOrder = ViewBag.SortOrder as string ?? "default";
    var pageRange = ViewBag.PageRange ?? 3;

    // --- START MODIFIED SECTION ---

    var currentUserId = Model.CurrentUser?.Id;

    var onlineUsers = Model.AllUsers
    .Where(dto => dto.IsOnline)
    .OrderBy(dto => dto.User.UserName)
    .ToList();

    var offlineUsers = Model.AllUsers
      .Where(dto => !dto.IsOnline)
      .OrderBy(dto => dto.User.UserName)
      .ToList();
}

<div class="container py-4">

    @if (Model.Products != null && Model.Products.Any())
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-end mb-3">
                    <div>
                        <h2 class="h4 fw-bold text-dark mb-1 amazon-heading">
                            @if (!string.IsNullOrEmpty(categoryName))
                            {
                                <span class="text-amazon-teal">Top Picks in </span> @categoryName
                            }
                            else
                            {
                                <span class="text-amazon-teal">Recommended </span> <span>For You</span>
                            }
                        </h2>
                        <p class="text-muted small mb-0 amazon-text">
                            @if (!string.IsNullOrEmpty(currentSearchTerm))
                            {
                                <span>Discover more items related to <strong class="text-dark">"@currentSearchTerm"</strong></span>
                            }
                            else
                            {
                                <span>Explore our latest collection below.</span>
                            }
                        </p>
                    </div>
                    <div class="slider-controls pb-1">
                        <button class="btn btn-sm btn-outline-secondary rounded-circle shadow-sm me-1" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary rounded-circle shadow-sm" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <div id="productCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="5000">
                    <div class="carousel-inner">
                        @{
                            // Taking top 12 products for the slider, 4 per slide
                            var sliderItems = Model.Products.Take(12).Select((v, i) => new { v, i })
                                              .GroupBy(x => x.i / 4)
                                              .ToList();
                        }

                        @for (int i = 0; i < sliderItems.Count; i++)
                        {
                            <div class="carousel-item @(i == 0 ? "active" : "")">
                                <div class="row g-2">
                                    @foreach (var item in sliderItems[i])
                                    {
                                        <div class="col-6 col-md-3">
                                            <div class="card border-0 shadow-sm h-100 slider-mini-card">
                                                <a asp-action="Product" asp-route-slug="@item.v.Slug" class="text-decoration-none">
                                                    <div class="slider-img-wrap rounded bg-light d-flex align-items-center justify-content-center p-2">
                                                        <img src="/media/products/@item.v.Image" 
                                                             class="img-fluid" 
                                                             alt="@item.v.Name"
                                                             onerror="this.src='/media/products/noimage.png';">
                                                    </div>
                                                    <div class="p-2 text-center">
                                                        <p class="small text-dark fw-bold mb-0 text-truncate">@item.v.Name</p>
                                                        <span class="text-amazon-teal small fw-bolder">@item.v.Price.ToString("C2")</span>
                                                    </div>
                                                </a>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    <hr class="mb-4" />

    <div class="row g-4">
        <div class="col-lg-12">

            <div class="row mb-4 align-items-end p-3 rounded shadow-sm bg-light border amazon-filter-bar">
                <div class="col-md-7">
                    <label for="searchTermInput" class="form-label fw-bold text-dark small mb-1 amazon-text">Filter Search:</label>
                    <form asp-controller="Products" asp-action="Index" method="get" class="d-flex input-group input-group-sm amazon-search-group">
                        <input type="hidden" name="slug" value="@currentCategorySlug" />
                        <input type="hidden" name="p" value="1" />
                        <input type="hidden" name="sortOrder" value="@sortOrder" />

                        <input type="text" name="searchTerm" id="searchTermInput" class="form-control form-control-sm amazon-search-input"
                               placeholder="Refine results..." value="@currentSearchTerm" />

                        <button type="submit" class="btn btn-amazon-search">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>

                <div class="col-md-5 mt-3 mt-md-0 d-flex justify-content-end align-items-center">
                    <label for="sortDropdown" class="form-label me-2 mb-0 small text-dark fw-bold amazon-text">Sort By:</label>

                    <select id="sortDropdown" class="form-select form-select-sm w-auto amazon-sort-dropdown">
                        <option value="default">Default</option>
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="name-asc">Name: A to Z</option>
                    </select>
                </div>
            </div>

            <div class="d-flex justify-content-start align-items-center mb-4 p-2 bg-light rounded shadow-sm border amazon-results-header">
                <h2 class="h6 text-muted mb-0 amazon-text">
                    <i class="fas fa-filter me-2"></i> Showing @Model.Products.Count() items on page @currentPage of @totalPages
                </h2>
            </div>

            <div class="row g-3 product-card-grid">
                @if (!Model.Products.Any())
                {
                    <div class="col-12">
                        <div class="alert alert-info text-center border-0 shadow-sm py-5" role="alert">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                            <h4 class="alert-heading">No Products Found!</h4>
                            <p>We couldn't find any items matching your current criteria.</p>
                            <a asp-controller="Products" asp-action="Index" class="btn btn-amazon-yellow mt-3"><i class="fas fa-undo me-2"></i> Browse All Products</a>
                        </div>
                    </div>
                }

                @foreach (var item in Model.Products)
                {
                    @* Main Grid: col-lg-3 and col-xl-3 ensures 4 items per row *@
                    <div class="col-xxl-3 col-xl-3 col-lg-3 col-md-4 col-sm-6 d-flex align-items-stretch">
                        <div class="card product-card w-100 rounded-3 shadow-sm">
                            <a asp-action="Product" asp-route-slug="@item.Slug" class="d-block product-image-wrapper">
                                <img src="/media/products/@item.Image" class="card-img-top product-img" alt="@item.Name" loading="lazy" onerror="this.onerror=null;this.src='/media/products/noimage.png';" />
                            </a>

                            <div class="card-body d-flex flex-column p-3">
                                @if (item.Category != null)
                                {
                                    <p class="card-text small mb-0 amazon-text">
                                        <a asp-action="Index" asp-route-slug="@item.Category.Slug" class="text-decoration-none product-category-link">
                                            @item.Category.Name
                                        </a>
                                    </p>
                                }

                                <h5 class="card-title product-name mt-1 mb-1">
                                    <a asp-action="Product" asp-route-slug="@item.Slug" class="text-dark text-decoration-none fw-semibold">
                                        @item.Name
                                    </a>
                                </h5>

                                <div class="mb-2 star-rating" aria-hidden="true">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star-half-alt"></i>
                                    <i class="far fa-star"></i>
                                </div>

                                <p class="card-text price-text fw-bolder fs-4 mt-auto mb-2">
                                    @item.Price.ToString("C2")
                                </p>

                                <div class="d-grid gap-2">
                                    <a asp-controller="Cart" asp-action="Add" asp-route-id="@item.Id"
                                       class="btn btn-amazon-yellow w-100 text-uppercase fw-bold btn-sm" role="button">
                                        <i class="fas fa-shopping-basket me-2"></i> Add to Cart
                                    </a>

                                    <a asp-controller="Cart" asp-action="Index"
                                       class="btn btn-amazon-outline w-100 text-uppercase fw-bold btn-sm" role="button">
                                        <i class="fas fa-shopping-cart me-2"></i> View Cart
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (totalPages > 1)
            {
                <div class="d-flex w-100 justify-content-center mt-5">
                    <front-pagination page-count="@totalPages"
                                      page-target="@currentCategorySlug"
                                      page-number="@currentPage"
                                      page-range="@pageRange"
                                      current-search-term="@currentSearchTerm"
                                      sort-order="@sortOrder">
                    </front-pagination>
                </div>
            }
        </div>

        @* Hidden Chat Sidebar Hub *@
        <div class="col-lg-3 d-none">
            <div id="chat-window-container"></div>
            <div id="chat-messages"></div>
            <input type="text" id="chat-input" />
            <button id="send-btn"></button>
            <button id="close-chat-btn"></button>
            <div id="user-list-view"></div>
            <a id="group-chat-link"></a>
        </div>
    </div>
</div>

<div class="d-none">
    <button id="open-chat-toggle"></button>
    <div id="floating-chat-modal">
        <h6 id="floating-chat-title"></h6>
        <button id="floating-chat-users-toggle"></button>
        <button id="floating-chat-minimize"></button>
        <button id="floating-chat-close"></button>
        <div id="floating-user-list"></div>
        <div id="floating-chat-messages"></div>
        <input type="text" id="floating-chat-input" />
        <button id="floating-chat-send"></button>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/amazon-style.css" asp-append-version="true" />
    <style>
        /* Slider Styling */
        .slider-mini-card { transition: transform 0.2s ease; border-radius: 8px; overflow: hidden; }
        .slider-mini-card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1) !important; }
        .slider-img-wrap { height: 120px; overflow: hidden; }
        .slider-img-wrap img { max-height: 100%; object-fit: contain; }
        .slider-controls .btn { width: 32px; height: 32px; padding: 0; line-height: 30px; border-color: #ddd; background: #fff; }
        .slider-controls .btn:hover { background: #f0f2f2; border-color: #adb1b8; color: #111; }
        .text-amazon-teal { color: #007185 !important; }

        /* Main Grid Image Normalization (Ensures 4 items per row look clean) */
        .product-img {
            height: 180px; 
            object-fit: contain; 
            padding: 10px;
        }
        .product-name {
            font-size: 0.95rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            height: 2.8rem;
        }
    </style>
}

@section Scripts {
    <script src="~/lib/microsoft-signalr/signalr.js"></script>
    <script src="~/js/chat-products.js" asp-append-version="true"></script>
    <script>
        ChatProductsModule.init({
            cS: @Html.Raw(Json.Serialize(currentCategorySlug ?? "")),
            cST: @Html.Raw(Json.Serialize(currentSearchTerm ?? "")),
            cSO: @Html.Raw(Json.Serialize(sortOrder ?? "default")),
            pIU: @Html.Raw(Json.Serialize(Url.Action("Index", "Products"))),
            currentUserId: '@User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value',
            chatEnabled: false 
        });
    </script>
}