@model IEnumerable<CMSECommerce.Models.OrderDetail>

@{
    // Architect Decision: Maintain separate lists for active vs cancelled to ensure data integrity
    var activeItems = Model.Where(d => !d.IsCancelled).ToList();
    ViewData["Title"] = ViewBag.IsProcessed ? "Processed Orders" : "New Orders (Unprocessed Items)";

    // Persistence for search parameters
    string currentSearchString = ViewBag.CurrentSearchString ?? string.Empty;
    string currentSearchField = ViewBag.CurrentSearchField ?? "Product";
}

<div class="container py-5">
    @* --- Page Header --- *@
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold text-dark">
                @(ViewBag.IsProcessed ? "✅ Processed & Shipped" : "🆕 New Orders Awaiting Action")
            </h1>
            <p class="lead text-muted">
                @(ViewBag.IsProcessed
                                ? "History of fulfilled items and tracking records."
                                : "Review, accept, and process new customer requests.")
            </p>
        </div>
        <div class="col-md-4 text-md-end">
            <a asp-action="@(ViewBag.IsProcessed ? "Index" : "Shipped")" class="btn btn-outline-primary shadow-sm px-4">
                <i class="fas @(ViewBag.IsProcessed ? "fa-inbox" : "fa-history") me-2"></i>
                View @(ViewBag.IsProcessed ? "New" : "Processed") Orders
            </a>
        </div>
    </div>

    @* --- Notifications --- *@
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm border-start border-4 border-success" role="alert">
            <i class="fas fa-check-circle me-2"></i> @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm border-start border-4 border-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @* --- Search Module --- *@
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
            <form asp-action="@(ViewBag.IsProcessed ? "Shipped" : "Index")" method="get">
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-filter text-muted"></i></span>
                    <select name="searchField" class="form-select" style="max-width: 160px;">
                        <option value="Product" selected="@(currentSearchField == "Product")">Product Name</option>
                        <option value="Customer" selected="@(currentSearchField == "Customer")">Customer</option>
                        <option value="OrderId" selected="@(currentSearchField == "OrderId")">Order ID</option>
                        <option value="Contact" selected="@(currentSearchField == "Contact")">Contact No.</option>
                    </select>
                    <input type="text" name="searchString" class="form-control" placeholder="Search orders..." value="@currentSearchString" />
                    <button class="btn btn-primary px-4" type="submit">
                        <i class="fas fa-search me-1"></i> Search
                    </button>
                    @if (!string.IsNullOrEmpty(currentSearchString))
                    {
                        <a asp-action="@(ViewBag.IsProcessed ? "Shipped" : "Index")" class="btn btn-secondary">Clear</a>
                    }
                </div>
            </form>
        </div>
    </div>

    @if (!activeItems.Any())
    {
        <div class="text-center py-5 bg-light rounded-3 border-dashed mt-4">
            <i class="fas @(ViewBag.IsProcessed ? "fa-box-open" : "fa-check-double") fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No orders found matching your criteria.</h4>
        </div>
    }
    else
    {
        @* --- Orders Table --- *@
        <div class="table-responsive shadow-sm rounded-3">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Item</th>
                        <th>Customer Details</th>
                        <th class="text-center">Qty</th>
                        <th>Subtotal</th>
                        <th>Current Status</th>
                        <th class="text-center">Action Workflow</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    @foreach (var item in activeItems.OrderBy(d => d.OrderId))
                    {
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="/media/products/@item.Image" class="rounded shadow-sm me-3"
                                         style="width: 50px; height: 50px; object-fit: cover;" alt="Product">
                                    <div>
                                        <div class="fw-bold text-dark">@item.ProductName</div>
                                        <small class="text-muted">Order #@item.OrderId</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="fw-semibold">@item.Customer</div>
                                <a href="tel:@item.CustomerNumber" class="small text-decoration-none">
                                    <i class="fas fa-phone-alt me-1"></i> @item.CustomerNumber
                                </a>
                            </td>
                            <td class="text-center">@item.Quantity</td>
                            <td class="fw-bold text-primary">
                                @((item.Price * item.Quantity).ToString("C", new System.Globalization.CultureInfo("en-IN")))
                            </td>
                            <td>
                                @if (item.IsProcessed)
                                {
                                    <span class="badge rounded-pill bg-success px-3">Shipped</span>
                                }
                                else if (item.SellerNote != null && item.SellerNote.Contains("Accepted"))
                                {
                                    <span class="badge rounded-pill bg-info text-dark px-3">Accepted</span>
                                }
                                else
                                {
                                    <span class="badge rounded-pill bg-warning text-dark px-3">Pending</span>
                                }
                            </td>
                            <td class="text-center">
                                <div class="btn-group shadow-sm rounded">
                                    @if (!item.IsProcessed)
                                    {
                                        @if (item.SellerNote == null || !item.SellerNote.Contains("Accepted"))
                                        {
                                            @* STEP 1: ACCEPT *@
                                            <form asp-action="AcceptOrder" asp-route-id="@item.Id" method="post" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-success btn-sm fw-bold px-3 border-end">
                                                    <i class="fas fa-check me-1"></i> Accept
                                                </button>
                                            </form>
                                        }
                                        else
                                        {
                                            @* STEP 2: PROCESS *@
                                            <button type="button" class="btn btn-primary btn-sm fw-bold px-3 border-end"
                                                    onclick="openProcessModal(@item.Id, '@item.ProductName')">
                                                <i class="fas fa-truck-loading me-1"></i> Process
                                            </button>
                                        }

                                        @* STEP 3: CANCEL (Always available until processed) *@
                                        <button type="button" class="btn btn-outline-danger btn-sm fw-bold px-3"
                                                onclick="openCancelModal(@item.Id, '@item.ProductName', @item.OrderId)">
                                            <i class="fas fa-times me-1"></i> Cancel
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-light btn-sm text-muted fw-bold px-3" disabled>
                                            <i class="fas fa-clipboard-check me-1"></i> Completed
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@* --- ARCHITECT COMPONENT: PROCESS MODAL (IMAGE UPLOAD) --- *@
<div class="modal fade" id="processModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <form asp-action="ProcessOrder" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-shipping-fast me-2"></i>Ship Item</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="OrderDetailId" id="processDetailId" />
                    <p class="small text-muted mb-4">Mark <strong id="processProductNameDisplay"></strong> as shipped and provide delivery details.</p>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-uppercase">Proof of Dispatch (Required)</label>
                        <input type="file" name="DeliveryImage" class="form-control" accept="image/*" required />
                        <div class="form-text">Upload a photo of the package or courier receipt.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-uppercase">Tracking Note</label>
                        <textarea name="Note" class="form-control" rows="2" placeholder="e.g. Dispatched via BlueDart. Tracking: #12345">Seller has shipped your order.</textarea>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary btn-sm px-3" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary btn-sm px-4 fw-bold">Update Tracking</button>
                </div>
            </form>
        </div>
    </div>
</div>

@* --- ARCHITECT COMPONENT: CANCEL MODAL --- *@
<div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <form asp-action="CancelOrder" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-exclamation-circle me-2"></i>Cancel Fulfillment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="OrderDetailId" id="cancelDetailId" />
                    <p>Are you sure you want to cancel item <strong id="cancelProductNameDisplay"></strong> for order <strong id="cancelOrderIdDisplay"></strong>?</p>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-uppercase">Cancellation Reason</label>
                        <select name="SelectedReason" id="reasonSelect" class="form-select" required onchange="checkCustomReason(this)">
                            <option value="" selected disabled>Select a valid reason...</option>
                            <option value="Out of Stock">Inventory: Out of Stock</option>
                            <option value="Pricing Error">Listing: Pricing Error</option>
                            <option value="Damaged Item">Quality: Damaged Item</option>
                            <option value="Shipping Restrictions">Logistics: Cannot Ship to Area</option>
                            <option value="Other">Other (Custom Reason)</option>
                        </select>
                    </div>

                    <div class="mb-3 d-none" id="customReasonBox">
                        <label class="form-label fw-bold small text-uppercase">Custom Details</label>
                        <textarea name="CustomReason" class="form-control" rows="2" placeholder="Provide reason for the customer..."></textarea>
                    </div>

                    <div class="alert alert-warning py-2 mb-0">
                        <i class="fas fa-info-circle me-1"></i> This action will notify the customer.
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary btn-sm px-3" data-bs-dismiss="modal">Keep Order</button>
                    <button type="submit" class="btn btn-danger btn-sm px-4 fw-bold">Confirm Cancellation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="fulfillModal" tabindex="-1">
    <div class="modal-dialog">
        <form asp-action="FulfillItem" method="post" enctype="multipart/form-data">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ship Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="OrderDetailId" id="modalItemId" />

                    <div class="mb-3">
                        <label class="form-label">Seller Note / Tracking Info</label>
                        <textarea name="SellerNote" class="form-control" placeholder="e.g. Left with neighbor at #42"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Proof of Delivery (Image)</label>
                        <input type="file" name="DeliveryImage" class="form-control" accept="image/*" required />
                        <small class="text-muted">Upload a photo of the package at the destination.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Mark as Dispatched</button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Use standard Bootstrap API for high reliability
        function openProcessModal(id, name) {
            document.getElementById('processDetailId').value = id;
            document.getElementById('processProductNameDisplay').innerText = name;
            var processModal = new bootstrap.Modal(document.getElementById('processModal'));
            processModal.show();
        }

        function openCancelModal(id, name, orderId) {
            document.getElementById('cancelDetailId').value = id;
            document.getElementById('cancelProductNameDisplay').innerText = name;
            document.getElementById('cancelOrderIdDisplay').innerText = "#" + orderId;
            var cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
            cancelModal.show();
        }

        function checkCustomReason(select) {
            const customBox = document.getElementById('customReasonBox');
            if (select.value === 'Other') {
                customBox.classList.remove('d-none');
                customBox.querySelector('textarea').required = true;
            } else {
                customBox.classList.add('d-none');
                customBox.querySelector('textarea').required = false;
            }
        }
    </script>
}