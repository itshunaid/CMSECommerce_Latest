@using CMSECommerce.Infrastructure
@using Microsoft.AspNetCore.Identity
@model Product
@inject Microsoft.AspNetCore.Identity.UserManager<IdentityUser> UserManager
@inject DataContext Context

@{
    ViewData["Title"] = "Create Product";

    // --- Subscription & Limit Validation Logic ---
    var userId = UserManager.GetUserId(User);
    var profile = Context.UserProfiles.FirstOrDefault(p => p.UserId == userId);

    // Count existing products for this seller
    var currentProductCount = Context.Products.Count(p => p.UserId == userId);

    // Condition Checks
    bool isExpired = profile?.SubscriptionEndDate < DateTime.Now;
    bool isLimitReached = profile != null && currentProductCount >= profile.CurrentProductLimit;
    bool canCreate = !isExpired && !isLimitReached;
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12 col-xl-10 mx-auto">
            <h1 class="mb-4">🛍️ Create New Product</h1>

            @* --- Alert Section: Subscription & Limit Messages --- *@
            @if (isExpired)
            {
                <div class="alert alert-danger shadow-sm border-start border-5 border-danger mb-4 py-3">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-calendar-times fa-3x me-3 text-danger"></i>
                            <div>
                                <h5 class="alert-heading mb-1 fw-bold">Subscription Expired</h5>
                                <p class="mb-0">Your access ended on <strong>@profile.SubscriptionEndDate?.ToString("dd MMM yyyy")</strong>. Please renew to continue listing new products.</p>
                            </div>
                        </div>
                        <a href="/Admin/Subscription/Status" class="btn btn-danger btn-lg shadow-sm">
                            <i class="fas fa-sync-alt me-2"></i>Renew Subscription
                        </a>
                    </div>
                </div>
            }
            else if (isLimitReached)
            {
                <div class="alert alert-warning shadow-sm border-start border-5 border-warning text-dark mb-4 py-3">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-circle fa-3x me-3 text-warning"></i>
                            <div>
                                <h5 class="alert-heading mb-1 fw-bold">Product Limit Reached</h5>
                                <p class="mb-0">You have used <strong>@currentProductCount</strong> of <strong>@profile.CurrentProductLimit</strong> available slots. Upgrade your plan to add more.</p>
                            </div>
                        </div>
                        <a href="/Admin/Subscription/Index" class="btn btn-warning btn-lg shadow-sm text-dark fw-bold">
                            <i class="fas fa-arrow-up me-2"></i>Upgrade Plan
                        </a>
                    </div>
                </div>
            }

            @* --- Main Product Form Card --- *@
            <div class="card shadow-sm @(!canCreate ? "bg-light opacity-75" : "")" style="@(!canCreate ? "pointer-events: none;" : "")">
                <div class="card-body p-4">
                    @if (canCreate && profile != null)
                    {
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0 text-primary fw-bold">Product Details</h5>
                            <span class="badge bg-info text-dark p-2 fs-6">
                                <i class="fas fa-check-circle me-1"></i> Remaining Slots: @(profile.CurrentProductLimit - currentProductCount)
                            </span>
                        </div>
                    }

                    <form asp-action="Create" enctype="multipart/form-data" class="row g-4">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <div class="col-md-6">
                            <label asp-for="Name" class="form-label fw-bold"></label>
                            <input asp-for="Name" class="form-control" placeholder="Enter product name" disabled="@(!canCreate)" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Price" class="form-label fw-bold">Price (₹)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-primary text-white">₹</span>
                                <input asp-for="Price" class="form-control" placeholder="0.00" type="number" step="0.01" disabled="@(!canCreate)" />
                            </div>
                            <span asp-validation-for="Price" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="StockQuantity" class="form-label fw-bold"></label>
                            <input asp-for="StockQuantity" type="number" min="0" class="form-control" value="0" disabled="@(!canCreate)" />
                            <span asp-validation-for="StockQuantity" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold" for="CategoryId">Category</label>

                            @* Hidden bound input for CategoryId (model binding) *@
                            <input asp-for="CategoryId" type="hidden" id="CategoryId" name="CategoryId" />

                            @* Hierarchical category dropdown *@
                            <select id="categoryDropdown" class="form-select" disabled="@(!canCreate)">
                                <option value="">-- Choose a category --</option>
                            </select>

                            <span asp-validation-for="CategoryId" class="text-danger"></span>
                        </div>

                        <div class="col-12">
                            <label asp-for="Description" class="form-label fw-bold"></label>
                            <textarea asp-for="Description" class="form-control" rows="5" placeholder="Detailed product description..."></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="col-12">
                            <label asp-for="ImageUpload" class="form-label fw-bold">Main Image</label>
                            <input asp-for="ImageUpload" class="form-control" type="file" onchange="img_pathUrl(this);" disabled="@(!canCreate)" />
                            <span asp-validation-for="ImageUpload" class="text-danger"></span>

                            <div class="mt-3">
                                <small class="text-muted d-block mb-2">Image Preview:</small>
                                <img src="https://via.placeholder.com/150x150?text=No+Image" id="imgpreview" class="img-thumbnail" alt="Preview" style="max-width: 150px; height: auto;" />
                            </div>
                        </div>

                        <div class="col-12 text-end border-top pt-4 mt-4">
                            @if (canCreate)
                            {
                                <button type="submit" class="btn btn-primary btn-lg px-5 shadow-sm">
                                    <i class="fas fa-plus-circle me-2"></i>Create Product
                                </button>
                            }
                            else
                            {
                                <button type="button" class="btn btn-secondary btn-lg px-5" disabled>
                                    <i class="fas fa-lock me-2"></i>Creation Locked
                                </button>
                            }
                        </div>
                    </form>
                </div>
            </div>

            <div class="mt-4">
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Back to List
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/classic/ckeditor.js"></script>
    <script src="/js/category-tree-selector.js"></script>

    <script>
        const canCreate = @canCreate.ToString().ToLower();

        ClassicEditor
            .create(document.querySelector('#Description'))
            .then(editor => {
                if (!canCreate) {
                    editor.enableReadOnlyMode("subscription-lock");
                }
            })
            .catch(error => {
                console.error(error);
            });

        function img_pathUrl(input) {
            if (input.files && input.files[0]) {
                const imgElement = document.getElementById('imgpreview');
                imgElement.src = URL.createObjectURL(input.files[0]);
                imgElement.style.display = 'block';
            }
        }

        // Initialize category tree dropdown
        document.addEventListener('DOMContentLoaded', function () {
            (async function() {
                try {
                    await CategoryTreeSelector.init('#categoryDropdown', '#CategoryId');
                } catch (e) {
                    console.warn('Category tree init failed', e);
                }
            })();
        });
    </script>
}
