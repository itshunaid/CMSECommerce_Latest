@using CMSECommerce.Models
@model IEnumerable<Product>

@{
    ViewData["Title"] = "Product Inventory";
    // Set pageAction explicitly to "Index" since PendingProducts is removed
    string pageAction = "Index";
    // Get current query parameters for persistence
    string currentSearch = Context.Request.Query["search"];
    string currentStatus = Context.Request.Query["status"];
}

@* ---------------------------------------------------------------------- *
 * TEMP DATA MESSAGES (Success/Error Popups)
 * ---------------------------------------------------------------------- *@
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i><strong>Success!</strong> @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-x-octagon-fill me-2"></i><strong>Error!</strong> @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}


@* --- Action Header and Controls --- *@
<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h1 class="text-primary"><i class="bi bi-boxes me-2"></i> Product Inventory</h1>
    <div class="d-flex gap-2">
        <a asp-action="Create" class="btn btn-success btn-lg shadow-sm">
            <i class="bi bi-plus-lg me-1"></i> Add Product
        </a>
    </div>
</div>

@* --- Filter and Search Bar (UPDATED) --- *@
<div class="row mb-4 align-items-end">
    @* Category Filter *@
    <div class="col-md-3">
        <label for="selectCategory" class="form-label text-muted fw-bold"><i class="bi bi-funnel me-1"></i> Filter by Category</label>
        <select id="selectCategory" class="form-select" asp-items="ViewBag.Categories">
            <option value="0">--- All Categories ---</option>
        </select>
    </div>

    @* Status Filter (NEW) *@
    <div class="col-md-3">
        <label for="selectStatus" class="form-label text-muted fw-bold"><i class="bi bi-activity me-1"></i> Filter by Status</label>
        <select id="selectStatus" class="form-select">
            <option value="">--- All Statuses ---</option>
            <option value="Approved" selected="@(currentStatus == "Approved")">Approved</option>
            <option value="Pending" selected="@(currentStatus == "Pending")">Pending</option>
            <option value="Rejected" selected="@(currentStatus == "Rejected")">Rejected</option>
        </select>
    </div>

    @* Search Query *@
    <div class="col-md-4">
        <label for="searchQuery" class="form-label text-muted fw-bold"><i class="bi bi-search me-1"></i> Search Products</label>
        <div class="input-group">
            <input type="text" id="searchQuery" class="form-control" placeholder="Search by name or keyword..." value="@currentSearch" />
            <button class="btn btn-primary" type="button" id="searchButton"><i class="bi bi-search me-1"></i> Search</button>
        </div>
    </div>

    <div class="col-md-2 text-end d-flex align-items-end justify-content-end">
        <span class="text-muted">Total Products: @(Model.Count())</span>
    </div>
</div>

<hr />

@* --- Product Listing Table (UNCHANGED) --- *@
<div class="table-responsive shadow-sm rounded-3">
    <table class="table table-striped table-hover align-middle border" id="productTable">
        <thead class="table-dark">
            <tr>
                <th style="width: 80px;">Image</th>
                <th>Name</th>
                <th style="width: 100px;"><i class="bi bi-currency-dollar me-1"></i> Price</th>
                <th style="width: 170px;"><i class="bi bi-box me-1"></i> Stock / Status</th>
                <th style="width: 120px;"><i class="bi bi-tags me-1"></i> Category</th>
                <th style="width: 100px;"><i class="bi bi-shield-check me-1"></i> Status</th>
                <th style="width: 250px;"><i class="bi bi-exclamation-triangle me-1"></i> Reject Reason</th>
                <th style="width: 160px;" class="text-center"><i class="bi bi-lightning-fill me-1"></i> Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        <img src="/media/products/@item.Image" class="img-thumbnail rounded" style="width: 60px; height: 60px; object-fit: cover;" alt="@item.Name" />
                    </td>
                    <td class="fw-bold">
                        @item.Name
                    </td>
                    <td>
                        <span class="text-success fw-bold">@item.Price.ToString("C2")</span>
                    </td>

                    <td>
                        <strong class="d-block mb-1">@item.StockQuantity</strong>
                        @if (item.StockQuantity > 0)
                        {
                            <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> In Stock</span>
                        }
                        else
                        {
                            <span class="badge bg-danger"><i class="bi bi-x-circle-fill"></i> Out of Stock</span>
                        }
                    </td>

                    <td>
                        <span class="text-muted small">@item.Category?.Name</span>
                    </td>
                    <td>
                        @* Status displayed using the simplified helper function *@
                        @Html.Raw(GetStatusBadge(item.Status.ToString()))
                    </td>


                    <td>
                        @if (item.Status.ToString() == "Rejected" && !string.IsNullOrEmpty(item.RejectionReason))
                        {
                            <span class="text-danger small fw-semibold" data-bs-toggle="tooltip" data-bs-placement="top" title="@item.RejectionReason">
                                @(item.RejectionReason.Length > 30 ? item.RejectionReason.Substring(0, 30) + "..." : item.RejectionReason)
                            </span>
                        }
                        else
                        {
                            <span class="text-muted fst-italic">N/A</span>
                        }
                    </td>


                    <td class="d-flex gap-1 justify-content-center">
                        @* UPDATED: Edit Button with Icon and Text *@
                        <a asp-action="Edit" asp-route-id="@item.Id"
                           class="btn btn-sm btn-info" title="Edit Product">
                            <i class="bi bi-pencil me-1"></i> Edit
                        </a>

                        @* UPDATED: Delete Button with Icon and Text *@
                        <a asp-action="Delete" class="btn btn-sm btn-danger confirm"
                           asp-route-id="@item.Id" title="Delete Product"
                           data-confirm-title="Delete Confirmation"
                           data-confirm-message="Are you sure you want to permanently delete this product?">
                            <i class="bi bi-trash me-1"></i> Delete
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<hr />

@* --- Pagination Area (UPDATED to include new parameters) --- *@
<div class="d-flex w-100 justify-content-center mt-4">
    <pagination page-count="@ViewBag.TotalPages"
                page-target="@pageAction"
                category-id="@ViewBag.SelectedCategory"
                page-number="@ViewBag.PageNumber"
                page-range="@ViewBag.PageRange"
                search-query="@currentSearch"
                status-filter="@currentStatus">
    </pagination>
</div>

@* --- HELPER FUNCTION FOR STATUS BADGE (UNCHANGED) --- *@
@functions {
    string GetStatusBadge(string status)
    {
        string colorClass;
        string icon;

        switch (status)
        {
            case "Approved":
                colorClass = "bg-success";
                icon = "bi bi-check-circle-fill";
                break;
            case "Rejected":
                colorClass = "bg-danger";
                icon = "bi bi-ban-fill";
                break;
            case "Pending":
            default:
                colorClass = "bg-warning text-dark";
                icon = "bi bi-clock-fill";
                break;
        }

        return $"<span class=\"badge {colorClass}\"><i class=\"{icon} me-1\"></i> {status}</span>";
    }
}


@section Scripts {
    <script>
        $(function () {
            // Initialize tooltips (important for displaying full reject reason)
            $('[data-bs-toggle="tooltip"]').tooltip();

            // --- 1. Category, Status, and Search Logic ---
            const baseUrl = "@Url.Action(pageAction)";

            function applyFilters() {
                const categoryId = $("#selectCategory").val();
                const status = $("#selectStatus").val(); // NEW: Get status value
                const searchQuery = $("#searchQuery").val().trim();
                let url = baseUrl;
                const params = [];

                if (categoryId !== "0") {
                    params.push("categoryId=" + categoryId);
                }
                // NEW: Add status parameter if selected
                if (status) {
                    params.push("status=" + status);
                }
                if (searchQuery) {
                    params.push("search=" + encodeURIComponent(searchQuery));
                }

                if (params.length > 0) {
                    url += "?" + params.join("&");
                }
                window.location = url;
            }

            $("#selectCategory").on("change", applyFilters);
            $("#selectStatus").on("change", applyFilters); // NEW: Trigger filter on status change
            $("#searchButton").on("click", applyFilters);
            $("#searchQuery").on("keypress", function (e) {
                if (e.which === 13) {
                    applyFilters();
                }
            });

            // --- 2. Confirmation Dialog for Delete Only (UNCHANGED) ---
            $('.confirm').on('click', function(e) {
                const btn = $(this);
                const title = btn.data('confirm-title') || 'Confirmation';
                const message = btn.data('confirm-message') || 'Are you sure you want to proceed?';

                if (!confirm(title + ": " + message)) {
                    e.preventDefault();
                }
            });
        });
    </script>
}