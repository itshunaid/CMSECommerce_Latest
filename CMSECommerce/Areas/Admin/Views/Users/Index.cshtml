@model global::System.Collections.Generic.IEnumerable<global::CMSECommerce.Areas.Admin.Models.UserViewModel>

@{
    ViewData["Title"] = "Users";
    var allRoles = ViewBag.AllRoles as List<string> ?? new List<string>();
    // Filter top users for the slider (e.g., first 5)
    var sliderUsers = Model.Take(5).ToList();
}

<style>
    :root {
        --amz-navy: #232f3e;
        --amz-navy-2: #1e2a33;
        --amz-orange: #febd69;
        --amz-orange-2: #f3a847;
        --amz-slate: #37475a;
        --amz-green: #007600;
        --amz-red: #b12704;
        --amz-gray-100: #f8f9fa;
        --amz-gray-200: #edf1f5;
        --amz-gray-300: #dfe5ea;
        --amz-gray-500: #6b7280;
        --amz-border: #d8dadd;
    }

    /* --- NEW SLIDER STYLES --- */
    .user-slider-container {
        width: 100%;
        overflow: hidden;
        margin-bottom: 25px;
        background: #fff;
        border-radius: 8px;
        border: 1px solid var(--amz-border);
        padding: 20px;
    }

    .user-slider-track {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        padding-bottom: 10px;
        scrollbar-width: thin;
        scrollbar-color: var(--amz-orange) transparent;
    }

    .slider-card {
        min-width: 200px;
        flex: 0 0 auto;
        text-align: center;
        padding: 15px;
        border: 1px solid var(--amz-gray-200);
        border-radius: 8px;
        transition: transform 0.2s;
        background: var(--amz-gray-100);
    }

        .slider-card:hover {
            transform: translateY(-5px);
            border-color: var(--amz-orange);
        }

        .slider-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    /* --- END SLIDER STYLES --- */

    /* --- GENERAL STYLES FOR USER INDEX --- */
    .table-responsive {
        overflow-x: auto;
        margin-bottom: 1.5rem;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

        .table th, .table td {
            padding: 0.75rem;
            vertical-align: middle;
            border-top: 1px solid var(--amz-border);
        }

        .table thead th {
            background: var(--amz-navy);
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }

    .btn-primary {
        background-color: var(--amz-orange);
        border-color: var(--amz-orange);
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        display: inline-block;
        transition: background-color 0.2s, border-color 0.2s;
    }

        .btn-primary:hover {
            background-color: var(--amz-orange-2);
            border-color: var(--amz-orange-2);
        }

    .btn-secondary {
        background-color: transparent;
        border-color: var(--amz-border);
        color: var(--amz-slate);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        display: inline-block;
        transition: background-color 0.2s, border-color 0.2s;
    }

        .btn-secondary:hover {
            background-color: var(--amz-gray-100);
        }

    .badge {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        border-radius: 1.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid transparent;
        transition: transform 0.2s;
    }

        .badge-green {
            color: var(--amz-green);
            border-color: #bfe3bf;
            background: #f0fff0;
        }

        .badge-red {
            color: var(--amz-red);
            border-color: #f4c7c4;
            background: #fff5f4;
        }

        .badge-warning {
            color: #8a5800;
            border-color: #ffd199;
            background: #fff4e6;
        }

    /* --- RESPONSIVE STYLES --- */
    @@media (max-width: 768px) {
        .table-responsive {
            margin-bottom: 1.5rem;
        }

        .table {
            font-size: 0.875rem;
        }

        .btn-primary, .btn-secondary {
            width: 100%;
            padding: 0.6rem;
        }
    }
</style>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h4">Users</h2>
        <div class="d-flex gap-2">
            <a asp-action="Create" class="btn btn-primary btn-sm">Create User</a>
            <a asp-action="ExportUsersCsv" class="btn btn-outline-secondary btn-sm">Export CSV</a>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role(s)</th>
                    <th>Profile</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach(var u in Model)
                {
                    <tr>
                        <td>@u.UserName</td>
                        <td>@u.Email</td>
                        <td>@u.PhoneNumber</td>
                        <td>@string.Join(", ", u.Roles)</td>
                        <td>
                            @if (!string.IsNullOrEmpty(u.ProfileImagePath))
                            {
                                <img src="@u.ProfileImagePath" style="height:36px;width:36px;border-radius:50%;object-fit:cover" />
                            }
                            else
                            {
                                <span class="text-muted small">No Profile</span>
                            }
                        </td>
                        <td class="text-end">
                            <a asp-action="Edit" asp-route-id="@u.Id" class="btn btn-sm btn-outline-primary">Edit</a>
                            <form asp-action="Delete" method="post" style="display:inline;" onsubmit="return confirm('Delete user and all data?');">
                                <input type="hidden" name="id" value="@u.Id" />
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        // All existing functions remain untouched to preserve functionality
        function toggleFilters() {
            document.getElementById('filterRow').classList.toggle('show-mobile');
        }

        function filterTable() {
            const filters = {
                userInfo: document.getElementById('filter-userinfo').value.toLowerCase(),
                email: document.getElementById('filter-email').value.toLowerCase(),
                profession: document.getElementById('filter-profession').value.toLowerCase(),
                role: document.getElementById('filter-role').value.toLowerCase(),
                visibility: document.getElementById('filter-visibility').value.toLowerCase(),
                status: document.getElementById('filter-status').value.toLowerCase()
            };

            const rows = document.querySelectorAll('#usersTbody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const data = {
                    userInfo: row.querySelector('[data-label="User Info"]').getAttribute('data-search-info'),
                    email: row.querySelector('[data-label="Email"]').getAttribute('data-search-info'),
                    profession: row.querySelector('[data-label="Profession"] input').value.toLowerCase(),
                    role: row.querySelector('[data-label="Role"] select').value.toLowerCase(),
                    visibility: row.getAttribute('data-visibility').toLowerCase(),
                    status: row.getAttribute('data-status').toLowerCase()
                };

                const match = (!filters.userInfo || data.userInfo.includes(filters.userInfo)) &&
                              (!filters.email || data.email.includes(filters.email)) &&
                              (!filters.profession || data.profession.includes(filters.profession)) &&
                              (!filters.role || filters.role === data.role) &&
                              (!filters.visibility || filters.visibility === data.visibility) &&
                              (!filters.status || filters.status === data.status);

                row.style.display = match ? '' : 'none';
                if (match) visibleCount++;
            });

            document.getElementById('user-count').textContent = visibleCount;
        }

        function resetFilters() {
            ['filter-userinfo', 'filter-email', 'filter-profession', 'filter-role', 'filter-visibility', 'filter-status'].forEach(id => {
                document.getElementById(id).value = '';
            });
            filterTable();
        }

        async function updateField(userId, fieldName, value) {
            const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;
            const inputElement = document.getElementById(fieldName.toLowerCase() + '-' + userId);
            const badgeElement = document.getElementById(`badge-${fieldName.toLowerCase()}-${userId}`);
            const row = inputElement.closest('tr');

            let finalValue = (typeof value === 'boolean') ? (value ? 'true' : 'false') : value;
            const data = new URLSearchParams({
                userId: userId,
                fieldName: fieldName,
                value: finalValue,
                __RequestVerificationToken: antiForgeryToken
            });

            try {
                const response = await fetch('/Admin/Users/UpdateUserField', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: data.toString()
                });

                if (response.ok) {
                    if (fieldName === 'IsProfileVisible') {
                        const txt = value ? 'Visible' : 'Hidden';
                        row.setAttribute('data-visibility', txt);
                        badgeElement.textContent = txt;
                        badgeElement.className = `badge ${value ? 'badge-green' : 'badge-red'}`;
                    }
                    if (fieldName === 'IsLockedOut') {
                        const txt = value ? 'Disabled' : 'Active';
                        row.setAttribute('data-status', txt);
                        badgeElement.textContent = txt;
                        badgeElement.className = `badge ${!value ? 'badge-green' : 'badge-red'}`;
                    }
                    if (fieldName === 'IsImageApproved') {
                        const txt = value ? 'Approved' : 'Pending';
                        badgeElement.textContent = txt;
                        badgeElement.className = `badge ${value ? 'badge-green' : 'badge-warning'}`;
                        const infoCell = row.querySelector('[data-search-info]');
                        infoCell.setAttribute('data-search-info', infoCell.getAttribute('data-search-info').replace(/approved|pending|no image/i, txt.toLowerCase()));
                    }
                    filterTable();
                } else {
                    alert('Update failed. Please refresh.');
                }
            } catch (error) {
                console.error(error);
                alert('Network error.');
            }
        }
    </script>
}