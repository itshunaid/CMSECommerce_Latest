@model global::System.Collections.Generic.IEnumerable<global::CMSECommerce.Areas.Admin.Models.UserViewModel>

@{
    ViewData["Title"] = "Users";
    var allRoles = ViewBag.AllRoles as List<string> ?? new List<string>();
    // Filter top users for the slider (e.g., first 5)
    var sliderUsers = Model.Take(5).ToList();
}

<style>
    :root {
        --amz-navy: #232f3e;
        --amz-navy-2: #1e2a33;
        --amz-orange: #febd69;
        --amz-orange-2: #f3a847;
        --amz-slate: #37475a;
        --amz-green: #007600;
        --amz-red: #b12704;
        --amz-gray-50: #f8f9fa;
        --amz-gray-100: #f1f3f4;
        --amz-gray-200: #e8eaed;
        --amz-gray-300: #dadce0;
        --amz-gray-500: #6b7280;
        --amz-border: #e0e0e0;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Modern Amazon-inspired container */
    .modern-container {
        background: #fff;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--amz-border);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .modern-header {
        background: linear-gradient(135deg, var(--amz-navy) 0%, var(--amz-navy-2) 100%);
        color: #fff;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--amz-border);
    }

        .modern-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

    .modern-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    /* Enhanced table styles */
    .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

        .modern-table thead th {
            background: var(--amz-gray-50);
            color: var(--amz-slate);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1rem 1.5rem;
            border-bottom: 2px solid var(--amz-border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modern-table tbody td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--amz-gray-200);
            vertical-align: middle;
            transition: background-color 0.15s ease;
        }

        .modern-table tbody tr:hover {
            background: var(--amz-gray-50);
        }

    /* Enhanced badge styles */
    .modern-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.875rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid transparent;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

        .modern-badge.badge-active {
            color: var(--amz-green);
            background: rgba(0, 118, 0, 0.1);
            border-color: rgba(0, 118, 0, 0.2);
        }

        .modern-badge.badge-locked {
            color: var(--amz-red);
            background: rgba(177, 39, 4, 0.1);
            border-color: rgba(177, 39, 4, 0.2);
        }

        .modern-badge.badge-deactivated {
            color: #6b7280;
            background: rgba(107, 114, 128, 0.1);
            border-color: rgba(107, 114, 128, 0.2);
        }

    /* Modern button styles - compact icon-only version */
    .modern-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.375rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        text-decoration: none;
        gap: 0.25rem;
        min-width: 32px;
        height: 32px;
    }

        .modern-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .modern-btn.btn-compact {
            padding: 0.25rem;
            min-width: 28px;
            height: 28px;
            font-size: 0.625rem;
        }

            .modern-btn.btn-compact svg {
                width: 12px;
                height: 12px;
            }

        .modern-btn.btn-primary {
            background: linear-gradient(135deg, var(--amz-orange) 0%, var(--amz-orange-2) 100%);
            color: #fff;
            border-color: var(--amz-orange);
        }

            .modern-btn.btn-primary:hover {
                background: linear-gradient(135deg, var(--amz-orange-2) 0%, #e6933a 100%);
                border-color: var(--amz-orange-2);
            }

        .modern-btn.btn-outline {
            background: transparent;
            color: var(--amz-slate);
            border-color: var(--amz-border);
        }

            .modern-btn.btn-outline:hover {
                background: var(--amz-gray-50);
                border-color: var(--amz-gray-300);
            }

        .modern-btn.btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #fff;
            border-color: #f59e0b;
        }

            .modern-btn.btn-warning:hover {
                background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
                border-color: #d97706;
            }

        .modern-btn.btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            border-color: #10b981;
        }

            .modern-btn.btn-success:hover {
                background: linear-gradient(135deg, #059669 0%, #047857 100%);
                border-color: #059669;
            }

        .modern-btn.btn-info {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: #fff;
            border-color: #06b6d4;
        }

            .modern-btn.btn-info:hover {
                background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
                border-color: #0891b2;
            }

        .modern-btn.btn-secondary {
            background: linear-gradient(135deg, var(--amz-gray-200) 0%, var(--amz-gray-300) 100%);
            color: var(--amz-slate);
            border-color: var(--amz-gray-300);
        }

            .modern-btn.btn-secondary:hover {
                background: linear-gradient(135deg, var(--amz-gray-300) 0%, var(--amz-gray-500) 100%);
                color: #374151;
            }

        .modern-btn.btn-danger {
            background: linear-gradient(135deg, var(--amz-red) 0%, #c53030 100%);
            color: #fff;
            border-color: var(--amz-red);
        }

            .modern-btn.btn-danger:hover {
                background: linear-gradient(135deg, #c53030 0%, #9b2c2c 100%);
                border-color: #c53030;
            }

    /* Profile image enhancement */
    .profile-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #fff;
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s ease;
    }

        .profile-avatar:hover {
            transform: scale(1.05);
        }

    /* Action buttons container */
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    /* Responsive design */
    @@media (max-width: 1024px) {
        .modern-header {
            padding: 1rem 1.5rem;
        }

        .modern-table thead th,
        .modern-table tbody td {
            padding: 0.75rem 1rem;
        }

        .action-buttons {
            flex-direction: column;
            align-items: stretch;
        }

        .modern-btn {
            width: 100%;
            justify-content: center;
        }
    }

    @@media (max-width: 768px) {
        .modern-container {
            border-radius: 8px;
            margin: 0 -1rem;
        }

        .modern-header {
            padding: 1rem;
        }

            .modern-header h2 {
                font-size: 1.25rem;
            }

        .modern-actions {
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }

        .modern-table {
            font-size: 0.875rem;
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
        }
    }
</style>

<div class="container-fluid py-4">
    <div class="modern-container">
        <div class="modern-header">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Users</h2>
                <div class="modern-actions">
                    <a asp-action="Create" class="modern-btn btn-primary">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                        </svg>
                        Create User
                    </a>
                    <a asp-action="ExportUsersCsv" class="modern-btn btn-outline">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Export CSV
                    </a>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Role(s)</th>
                        <th>Profile</th>
                        <th>Locked</th>
                        <th>Deactivated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach(var u in Model)
                    {
                        <tr>
                            <td>
                                <div class="fw-semibold">@u.UserName</div>
                            </td>
                            <td>
                                <div class="text-muted">@u.Email</div>
                            </td>
                            <td>
                                <div>@u.PhoneNumber</div>
                            </td>
                            <td>
                                <div class="d-flex flex-wrap gap-1">
                                    @foreach(var role in u.Roles)
                                    {
                                        <span class="modern-badge badge-active">@role</span>
                                    }
                                </div>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(u.ProfileImagePath))
                                {
                                    <img src="@u.ProfileImagePath" alt="Profile" class="profile-avatar" />
                                }
                                else
                                {
                                    <div class="text-muted small">No Profile</div>
                                }
                            </td>
                            <td>
                                @if (u.IsLockedOut)
                                {
                                    <span class="modern-badge badge-locked">
                                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                                        </svg>
                                        Locked
                                    </span>
                                }
                                else
                                {
                                    <span class="modern-badge badge-active">
                                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                                        </svg>
                                        Active
                                    </span>
                                }
                            </td>
                            <td>
                                @if (u.IsDeactivated)
                                {
                                    <span class="modern-badge badge-deactivated">
                                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                            <path d="M5 6.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0zm1.138-1.496a.552.552 0 0 1 .554.554c0 .478-.396.853-.836.853a.552.552 0 0 1-.554-.554c0-.478.396-.853.836-.853z"/>
                                        </svg>
                                        Deactivated
                                    </span>
                                }
                                else
                                {
                                    <span class="modern-badge badge-active">
                                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                                        </svg>
                                        Active
                                    </span>
                                }
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a asp-action="Edit" asp-route-id="@u.Id" class="modern-btn btn-compact btn-outline" title="Edit User">
                                        <svg fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                            <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 0 .5.5h-11a.5.5 0 0 0-.5-.5v-11a.5.5 0 0 0 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                                        </svg>
                                    </a>
                                    @if (!u.IsDeactivated)
                                    {
                                        <form asp-action="SoftDelete" method="post" style="display:inline;" onsubmit="return confirm('Soft delete user? Profile will be hidden and products set to pending.');">
                                            <input type="hidden" name="id" value="@u.Id" />
                                            <button type="submit" class="modern-btn btn-compact btn-warning" title="Soft Delete User">
                                                <svg fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                </svg>
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <form asp-action="Restore" method="post" style="display:inline;" onsubmit="return confirm('Restore user? Profile will be visible and products set to approved.');">
                                            <input type="hidden" name="id" value="@u.Id" />
                                            <button type="submit" class="modern-btn btn-compact btn-success" title="Restore User">
                                                <svg fill="currentColor" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                                                </svg>
                                            </button>
                                        </form>
                                    }
                                    <form asp-action="EnableDisable" method="post" style="display:inline;" onsubmit="return confirm('@(u.IsLockedOut ? "Unlock" : "Lock") user account?');">
                                        <input type="hidden" name="id" value="@u.Id" />
                                        <button type="submit" class="modern-btn btn-compact @(u.IsLockedOut ? "btn-info" : "btn-secondary")" title="@(u.IsLockedOut ? "Unlock" : "Lock") Account">
                                            @if (u.IsLockedOut)
                                            {
                                                <svg fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2z"/>
                                                    <path d="M3 8a1 1 0 0 0-1 1v5a1 1 0 0 1-1-1V9a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2z"/>
                                                </svg>
                                            }
                                            else
                                            {
                                                <svg fill="currentColor" viewBox="0 0 16 16">
                                                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                                                </svg>
                                            }
                                        </button>
                                    </form>
                                    <form asp-action="Delete" method="post" style="display:inline;" onsubmit="return confirm('Permanently delete user and all data? This cannot be undone.');">
                                        <input type="hidden" name="id" value="@u.Id" />
                                        <button type="submit" class="modern-btn btn-compact btn-danger" title="Hard Delete User">
                                            <svg fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // All existing functions remain untouched to preserve functionality
        function toggleFilters() {
            document.getElementById('filterRow').classList.toggle('show-mobile');
        }

        function filterTable() {
            const filters = {
                userInfo: document.getElementById('filter-userinfo').value.toLowerCase(),
                email: document.getElementById('filter-email').value.toLowerCase(),
                profession: document.getElementById('filter-profession').value.toLowerCase(),
                role: document.getElementById('filter-role').value.toLowerCase(),
                visibility: document.getElementById('filter-visibility').value.toLowerCase(),
                status: document.getElementById('filter-status').value.toLowerCase()
            };

            const rows = document.querySelectorAll('#usersTbody tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const data = {
                    userInfo: row.querySelector('[data-label="User Info"]').getAttribute('data-search-info'),
                    email: row.querySelector('[data-label="Email"]').getAttribute('data-search-info'),
                    profession: row.querySelector('[data-label="Profession"] input').value.toLowerCase(),
                    role: row.querySelector('[data-label="Role"] select').value.toLowerCase(),
                    visibility: row.getAttribute('data-visibility').toLowerCase(),
                    status: row.getAttribute('data-status').toLowerCase()
                };

                const match = (!filters.userInfo || data.userInfo.includes(filters.userInfo)) &&
                              (!filters.email || data.email.includes(filters.email)) &&
                              (!filters.profession || data.profession.includes(filters.profession)) &&
                              (!filters.role || filters.role === data.role) &&
                              (!filters.visibility || filters.visibility === data.visibility) &&
                              (!filters.status || filters.status === data.status);

                row.style.display = match ? '' : 'none';
                if (match) visibleCount++;
            });

            document.getElementById('user-count').textContent = visibleCount;
        }

        function resetFilters() {
            ['filter-userinfo', 'filter-email', 'filter-profession', 'filter-role', 'filter-visibility', 'filter-status'].forEach(id => {
                document.getElementById(id).value = '';
            });
            filterTable();
        }

        async function updateField(userId, fieldName, value) {
            const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;
            const inputElement = document.getElementById(fieldName.toLowerCase() + '-' + userId);
            const badgeElement = document.getElementById(`badge-${fieldName.toLowerCase()}-${userId}`);
            const row = inputElement.closest('tr');

            let finalValue = (typeof value === 'boolean') ? (value ? 'true' : 'false') : value;
            const data = new URLSearchParams({
                userId: userId,
                fieldName: fieldName,
                value: finalValue,
                __RequestVerificationToken: antiForgeryToken
            });

            try {
                const response = await fetch('/Admin/Users/UpdateUserField', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: data.toString()
                });

                if (response.ok) {
                    if (fieldName === 'IsProfileVisible') {
                        const txt = value ? 'Visible' : 'Hidden';
                        row.setAttribute('data-visibility', txt);
                        badgeElement.textContent = txt;
                        badgeElement.className = `badge ${value ? 'badge-green' : 'badge-red'}`;
                    }
                    if (fieldName === 'IsLockedOut') {
                        const txt = value ? 'Disabled' : 'Active';
                        row.setAttribute('data-status', txt);
                        badgeElement.textContent = txt;
                        badgeElement.className = `badge ${!value ? 'badge-green' : 'badge-red'}`;
                    }
                    if (fieldName === 'IsImageApproved') {
                        const txt = value ? 'Approved' : 'Pending';
                        badgeElement.textContent = txt;
                        badgeElement.className = `badge ${value ? 'badge-green' : 'badge-warning'}`;
                        const infoCell = row.querySelector('[data-search-info]');
                        infoCell.setAttribute('data-search-info', infoCell.getAttribute('data-search-info').replace(/approved|pending|no image/i, txt.toLowerCase()));
                    }
                    filterTable();
                } else {
                    alert('Update failed. Please refresh.');
                }
            } catch (error) {
                console.error(error);
                alert('Network error.');
            }
        }
    </script>
}