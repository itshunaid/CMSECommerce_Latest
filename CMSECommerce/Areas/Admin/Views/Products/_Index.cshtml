@using CMSECommerce.Models
@model IEnumerable<Product>

@{
    ViewData["Title"] = "Product Inventory";
    // Get the current action for correct pagination link building
    string pageAction = (string)ViewBag.PageAction ?? "Index";
}

@* ---------------------------------------------------------------------- *
 * TEMP DATA MESSAGES (Success/Error Popups)
 * ---------------------------------------------------------------------- *@
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i><strong>Success!</strong> @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-x-octagon-fill me-2"></i><strong>Error!</strong> @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}


@* --- Action Header and Controls --- *@
<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h1 class="text-primary"><i class="bi bi-boxes me-2"></i> Product Inventory</h1>
    <div class="d-flex gap-2">
        <a asp-action="Create" class="btn btn-success btn-lg shadow-sm">
            <i class="bi bi-plus-lg me-1"></i> Add Product
        </a>
        <a asp-action="PendingProducts" class="btn btn-warning btn-lg shadow-sm">
            <i class="bi bi-clock me-1"></i> Pending Review
        </a>
    </div>
</div>

@* --- Filter and Search Bar --- *@
<div class="row mb-4 align-items-end">
    <div class="col-md-4">
        <label for="selectCategory" class="form-label text-muted fw-bold"><i class="bi bi-funnel me-1"></i> Filter by Category</label>
        <select id="selectCategory" class="form-select" asp-items="ViewBag.Categories">
            <option value="0">--- All Categories ---</option>
        </select>
    </div>

    <div class="col-md-5">
        <label for="searchQuery" class="form-label text-muted fw-bold"><i class="bi bi-search me-1"></i> Search Products</label>
        <div class="input-group">
            <input type="text" id="searchQuery" class="form-control" placeholder="Search by name or keyword..." />
            <button class="btn btn-outline-secondary" type="button" id="searchButton"><i class="bi bi-arrow-right"></i></button>
        </div>
    </div>

    <div class="col-md-3 text-end">
        <span class="text-muted">Total Products: @(Model.Count())</span>
    </div>
</div>

<hr />

@* --- Product Listing Table --- *@
<div class="table-responsive shadow-sm rounded-3">
    <table class="table table-striped table-hover align-middle border" id="productTable">
        <thead class="table-dark">
            <tr>
                <th style="width: 80px;">Image</th>
                <th>Name</th>
                <th style="width: 100px;"><i class="bi bi-currency-dollar me-1"></i> Price</th>
                <th style="width: 170px;"><i class="bi bi-box me-1"></i> Stock / Status</th>
                <th style="width: 120px;"><i class="bi bi-tags me-1"></i> Category</th>
                <th style="width: 140px;"><i class="bi bi-shield-check me-1"></i> Review Status</th>
                <th style="width: 250px;">Actions / Review</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        <img src="/media/products/@item.Image" class="img-thumbnail rounded" style="width: 60px; height: 60px; object-fit: cover;" alt="@item.Name" />
                    </td>
                    <td class="fw-bold">
                        @item.Name
                    </td>
                    <td>
                        <span class="text-success fw-bold">@item.Price.ToString("C2")</span>
                    </td>

                    <td>
                        <strong class="d-block mb-1">@item.StockQuantity</strong>
                        @if (item.StockQuantity > 0)
                        {
                            <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> In Stock</span>
                        }
                        else
                        {
                            <span class="badge bg-danger"><i class="bi bi-x-circle-fill"></i> Out of Stock</span>
                        }
                    </td>

                    <td>
                        <span class="text-muted small">@item.Category?.Name</span>
                    </td>
                    <td>
                        @Html.Raw(GetStatusBadge(item.Status.ToString(), item.RejectionReason))
                    </td>
                    <td class="d-flex gap-1 align-items-center">

                        @* **THIS IS THE CORRECT CONDITIONAL LOGIC** *@
                        @if (item.Status == ProductStatus.Approved)
                        {
                            <a asp-action="Unapprove" asp-route-id="@item.Id"
                               class="btn btn-sm btn-outline-secondary confirm" title="Unapprove Product"
                               data-confirm-title="Unapprove Confirmation"
                               data-confirm-message="Are you sure you want to revert this product to Pending status?">
                                <i class="bi bi-arrow-down-circle me-1"></i>Unapprove
                            </a>
                        }
                        else
                        {
                            <a asp-action="Approve" asp-route-id="@item.Id"
                               class="btn btn-sm btn-success confirm" title="Approve Product"
                               data-confirm-title="Approve Confirmation"
                               data-confirm-message="Are you sure you want to approve this product and make it live?">
                                <i class="bi bi-check-circle me-1"></i>Approve
                            </a>

                            <button type="button" class="btn btn-sm btn-danger reject-btn"
                                    data-id="@item.Id" data-name="@item.Name" title="Reject Product">
                                <i class="bi bi-x-octagon me-1"></i>Reject
                            </button>
                        }

                        <div class="vr mx-1"></div>

                        <a asp-action="Edit" asp-route-id="@item.Id"
                           class="btn btn-sm btn-primary" title="Edit Product">
                            <i class="bi bi-pencil"></i>
                        </a>

                        <a asp-action="Delete" class="btn btn-sm btn-danger confirm"
                           asp-route-id="@item.Id" title="Delete Product"
                           data-confirm-title="Delete Confirmation"
                           data-confirm-message="Are you sure you want to permanently delete this product?">
                            <i class="bi bi-trash"></i>
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<hr />

@* --- Pagination Area --- *@
<div class="d-flex w-100 justify-content-center mt-4">
    <pagination page-count="@ViewBag.TotalPages"
                page-target="@pageAction"
                category-id="@ViewBag.SelectedCategory"
                page-number="@ViewBag.PageNumber"
                page-range="@ViewBag.PageRange">
    </pagination>
</div>

@* --- Reject Modal --- *@
<form id="rejectForm" method="post" asp-action="Reject">
    @Html.AntiForgeryToken()
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectModalLabel"><i class="bi bi-x-octagon text-danger me-1"></i> Reject Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="rejectProductId" />
                    <div class="mb-3">
                        <label for="rejectProductName" class="form-label">Product</label>
                        <input type="text" id="rejectProductName" class="form-control" readonly />
                    </div>
                    <div class="mb-3">
                        <label for="rejectReason" class="form-label">Reason</label>
                        <textarea id="rejectReason" name="reason" class="form-control" rows="4" required placeholder="Provide a detailed reason for rejection..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger"><i class="bi bi-x me-1"></i> Reject</button>
                </div>
            </div>
        </div>
    </div>
</form>

@* --- HELPER FUNCTION FOR STATUS BADGE --- *@
@functions {
    string GetStatusBadge(string status, string rejectionReason)
    {
        string colorClass;
        string icon;
        string tooltip = "";

        switch (status)
        {
            case "Approved":
                colorClass = "bg-success";
                icon = "bi bi-check-circle-fill";
                break;
            case "Rejected":
                colorClass = "bg-danger";
                icon = "bi bi-ban-fill";
                if (!string.IsNullOrEmpty(rejectionReason))
                {
                    tooltip = $"data-bs-toggle=\"tooltip\" data-bs-placement=\"top\" title=\"Reason: {rejectionReason}\"";
                }
                break;
            case "Pending":
            default:
                colorClass = "bg-warning text-dark";
                icon = "bi bi-clock-fill";
                break;
        }

        string badge = $"<span class=\"badge {colorClass}\" {tooltip}><i class=\"{icon} me-1\"></i> {status}</span>";

        if (status == "Rejected" && !string.IsNullOrEmpty(rejectionReason))
        {
            badge += $"<div class=\"text-muted small mt-1\">Reason: {rejectionReason}</div>";
        }

        return badge;
    }
}


@section Scripts {
    <script>
        $(function () {
            // Initialize tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();

            // --- 1. Category Filter & Search Logic (Updated to use dynamic base URL) ---
            const baseUrl = "@Url.Action(pageAction)";

            function applyFilters() {
                const categoryId = $("#selectCategory").val();
                const searchQuery = $("#searchQuery").val().trim();
                let url = baseUrl;
                const params = [];

                if (categoryId !== "0") {
                    params.push("categoryId=" + categoryId);
                }
                if (searchQuery) {
                    params.push("search=" + encodeURIComponent(searchQuery));
                }

                if (params.length > 0) {
                    url += "?" + params.join("&");
                }
                window.location = url;
            }

            $("#selectCategory").on("change", applyFilters);
            $("#searchButton").on("click", applyFilters);
            $("#searchQuery").on("keypress", function (e) {
                if (e.which === 13) {
                    applyFilters();
                }
            });

            // --- 2. Reject Modal Logic ---
            $('.reject-btn').on('click', function () {
                var id = $(this).data('id');
                var name = $(this).data('name');
                $('#rejectProductId').val(id);
                $('#rejectProductName').val(name);
                $('#rejectReason').val(''); // Clear previous reason
                var modalEl = document.getElementById('rejectModal');
                var modal = new bootstrap.Modal(modalEl);
                modal.show();
            });

            // --- 3. Confirmation Dialog for Approve/Delete/Unapprove ---
            $('.confirm').on('click', function(e) {
                const btn = $(this);
                const title = btn.data('confirm-title') || 'Confirmation';
                const message = btn.data('confirm-message') || 'Are you sure you want to proceed?';

                // In a real application, replace this with a beautiful modal confirmation
                if (!confirm(title + ": " + message)) {
                    e.preventDefault();
                }
            });
        });
    </script>
}