@model CMSECommerce.Areas.Admin.Models.ProductListViewModel
@using CMSECommerce.Areas.Admin.Models

@{
    ViewData["Title"] = "Product List";
}

<div class="container mt-4">
    <h2 class="text-primary">Product List</h2>
    <p>
        <a asp-action="Create" class="btn btn-success">Create New Product</a>
    </p>

    <form asp-action="Index" method="get" class="mb-3">
        <div class="row">
            <div class="col-md-3">
                <input type="text" name="SearchName" class="form-control" placeholder="Filter by Name" value="@Model.CurrentSearchName" />
            </div>
            <div class="col-md-3">
                <input type="text" name="SearchDescription" class="form-control" placeholder="Filter by Description" value="@Model.CurrentSearchDescription" />
            </div>
            <div class="col-md-3">
                <input type="text" name="SearchCategory" class="form-control" placeholder="Filter by Category" value="@Model.CurrentSearchCategory" />
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary">Filter</button>
                <a asp-action="Index" class="btn btn-secondary">Clear</a>
            </div>
        </div>
        <input type="hidden" name="SortOrder" value="@Model.CurrentSortOrder" />
        <input type="hidden" name="pageSize" value="@Model.CurrentPageSize" /> @* Preserves the current page size on filter *@
    </form>

    @{
        // 1. Prepare base route data, including search terms and page size.
        var baseParams = new Dictionary<string, string>
        {
        { "SearchName", Model.CurrentSearchName },
        { "SearchDescription", Model.CurrentSearchDescription },
        { "SearchCategory", Model.CurrentSearchCategory },
        { "pageSize", Model.CurrentPageSize.ToString() }
        };
    }

    @if (Model.Products == null || !Model.Products.Any())
    {
        <div class="alert alert-info" role="alert">
            No products found matching the criteria.
        </div>
    }
    else
    {
        <table class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>
                        <a asp-action="Index"
                           asp-route-sortOrder="@(Model.CurrentSortOrder == "Name" ? "name_desc" : "Name")"
                           asp-all-route-data="baseParams">
                            Name @(Model.CurrentSortOrder == "Name" ? "▲" : (Model.CurrentSortOrder == "name_desc" ? "▼" : ""))
                        </a>
                    </th>
                    <th>
                        Description
                    </th>
                    <th>
                        <a asp-action="Index"
                           asp-route-sortOrder="@(Model.CurrentSortOrder == "Price" ? "price_desc" : "Price")"
                           asp-all-route-data="baseParams">
                            Price @(Model.CurrentSortOrder == "Price" ? "▲" : (Model.CurrentSortOrder == "price_desc" ? "▼" : ""))
                        </a>
                    </th>
                    <th>
                        <a asp-action="Index"
                           asp-route-sortOrder="@(Model.CurrentSortOrder == "Category" ? "category_desc" : "Category")"
                           asp-all-route-data="baseParams">
                            Category @(Model.CurrentSortOrder == "Category" ? "▲" : (Model.CurrentSortOrder == "category_desc" ? "▼" : ""))
                        </a>
                    </th>
                    <th>Status</th> @* New column for Status badge *@
                    <th class="text-nowrap">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Products)
                {
                    <tr>
                        <td>
                            @Html.DisplayFor(modelItem => item.Name)
                        </td>
                        <td>
                            @Html.Raw(item.Description)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Price)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Category.Name)
                        </td>
                        <td>
                            <span class="badge
                                        @(item.Status == ProductStatus.Approved ? "bg-success" :
                                                                    item.Status == ProductStatus.Pending ? "bg-warning text-dark" : "bg-danger")">
                        @item.Status
                    </span>
                </td>
                <td class="text-nowrap">
                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-info">Edit</a>

                    @if (item.Status == ProductStatus.Pending)
                            {
                                <a asp-action="Approve" asp-route-id="@item.Id" class="btn btn-sm btn-success">Approve</a>
                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal" data-product-id="@item.Id">
                                    Reject
                                </button>
                            }
                            else if (item.Status == ProductStatus.Approved)
                            {
                                <a asp-action="Unapprove" asp-route-id="@item.Id" class="btn btn-sm btn-warning text-dark">Unapprove</a>
                            }

                            <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-danger delete-product"
                               onclick="return confirm('Are you sure you want to delete @item.Name?');">
                                Delete
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="d-flex flex-column align-items-center mt-4">
            <p class="mb-2">
                Page @(Model.Products.TotalPages > 0 ? Model.Products.PageIndex : 0) of @Model.Products.TotalPages
            </p>

            <nav aria-label="Page navigation" class="mb-0">
                <ul class="pagination mb-0">

                    <li class="page-item @(!Model.Products.HasPreviousPage ? "disabled" : "")">
                        @{
                            // Route data for previous page
                            var prevParams = new Dictionary<string, string>(baseParams)
                                        {
                                        { "SortOrder", Model.CurrentSortOrder },
                                        { "pageNumber", (Model.Products.PageIndex - 1).ToString() }
                                        };
                        }
                        <a class="page-link"
                           asp-action="Index"
                           asp-all-route-data="prevParams">
                            Previous
                        </a>
                    </li>

                    @for (int i = 1; i <= Model.Products.TotalPages; i++)
                    {
                        // Route data for the current number link
                        var pageParams = new Dictionary<string, string>(baseParams)
                                {
                                { "SortOrder", Model.CurrentSortOrder },
                                { "pageNumber", i.ToString() }
                                };

                        <li class="page-item @(i == Model.Products.PageIndex ? "active" : "")">
                            <a class="page-link"
                               asp-action="Index"
                               asp-all-route-data="pageParams">
                                @i
                            </a>
                        </li>
                    }

                    <li class="page-item @(!Model.Products.HasNextPage ? "disabled" : "")">
                        @{
                            // Route data for next page
                            var nextParams = new Dictionary<string, string>(baseParams)
                                        {
                                        { "SortOrder", Model.CurrentSortOrder },
                                        { "pageNumber", (Model.Products.PageIndex + 1).ToString() }
                                        };
                        }
                        <a class="page-link"
                           asp-action="Index"
                           asp-all-route-data="nextParams">
                            Next
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>

@* --- Rejection Modal Definition --- *@
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="rejectForm" asp-action="Reject" method="post">
            @Html.AntiForgeryToken() @* Ensures the Anti-Forgery Token is included for security *@
            <input type="hidden" name="id" id="reject-product-id" />

            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectModalLabel">Reject Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="reason">Reason for Rejection:</label>
                        <textarea name="reason" id="reason" class="form-control" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Confirm Reject</button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // JavaScript to capture the product ID when the Reject button is clicked and populate the modal form
        document.addEventListener('DOMContentLoaded', function () {
            var rejectModal = document.getElementById('rejectModal');
            if (rejectModal) {
                rejectModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget; // Button that triggered the modal
                    var productId = button.getAttribute('data-product-id'); // Extract ID from data-product-id attribute

                    var modalInput = rejectModal.querySelector('#reject-product-id');
                    modalInput.value = productId;
                });
            }
        });
    </script>
}